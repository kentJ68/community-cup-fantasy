<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Contests • Beowulf Fantasy League</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>

<!-- Global Layout System -->
<script src="/js/layout.js"></script>

<main class="main">

  <h2>Contests</h2>
  <p class="muted">Join a contest and compete with other players in the selected match.</p>

  <!-- SELECT MATCH -->
  <section class="card">
    <label>Select Match</label>
    <select id="matchSelect" class="input"></select>
  </section>

  <!-- CONTEST LIST -->
  <section class="card">
    <h3>Available Contests</h3>
    <div id="contestList" class="muted">Choose a match</div>
  </section>

</main>


<script>
// ---------------------------
// Load all matches
// ---------------------------
(async function loadMatches() {
  try {
    const r = await fetch('/api/matches');
    const matches = await r.json();

    const box = document.getElementById('matchSelect');
    if (!matches.length) {
      box.innerHTML = "<option>No matches</option>";
      return;
    }

    box.innerHTML = matches.map(m => `
      <option value="${m._id}">${m.name}</option>
    `).join("");

    loadContests(matches[0]._id);

    box.addEventListener("change", e => loadContests(e.target.value));

  } catch (err) {
    console.error(err);
  }
})();


// ---------------------------
// Load contests for a match
// ---------------------------
async function loadContests(matchId) {
  const box = document.getElementById("contestList");

  try {
    const r = await fetch(`/api/matches/${matchId}/contests`);
    const contests = await r.json();

    if (!contests.length) {
      box.innerHTML = "<div class='muted'>No contests for this match.</div>";
      return;
    }

    box.innerHTML = contests.map(c => `
      <div class="match-row">
        <strong>${c.title}</strong><br>
        <span class="muted small">${c.entryFee} entry • Max ${c.maxEntries || '-'} entries</span><br>
        <button class="btn-primary" style="margin-top:6px;" onclick="joinContest('${c._id}', '${c.matchId}')">
          Join
        </button>
      </div>
    `).join("");

  } catch (err) {
    console.error(err);
    box.innerHTML = "Failed to load contests.";
  }
}


// ---------------------------
// Join Contest
// ---------------------------
async function joinContest(contestId, matchId) {
  const token = localStorage.getItem("token");

  if (!token) {
    alert("Please login before joining a contest.");
    return;
  }

  // First check if user has a team for this match
  const hasTeam = await checkIfUserHasTeam(matchId);

  if (!hasTeam) {
    if (confirm("You must create a team to join this contest. Create now?")) {
      window.location.href = "/create-team.html";
    }
    return;
  }

  const viewerName = prompt("Enter your display name:");

  if (!viewerName || viewerName.trim() === "") {
    alert("Display name is required.");
    return;
  }

  // Create entry
  const payload = {
    viewerName,
    players: [],      // server ignores players for contest join
    captain: null
  };

  const r = await fetch(`/api/contests/${contestId}/join`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const j = await r.json();

  if (j.ok) {
    alert("Joined contest successfully!");
    return;
  } else {
    alert("Error: " + (j.error || "unknown"));
  }
}


// ---------------------------
// Check if the user has a team
// ---------------------------
async function checkIfUserHasTeam(matchId) {
  const r = await fetch(`/api/matches/${matchId}/teams`);
  try {
    const teams = await r.json();

    const token = localStorage.getItem("token");
    if (!token) return false;

    const me = await fetch("/api/me", { headers:{ Authorization:"Bearer " + token }});
    const user = await me.json();

    const myName = user?.user?.displayName;
    if (!myName) return false;

    return teams.some(t => t.viewerName === myName);

  } catch {
    return false;
  }
}
</script>

</body>
</html>
