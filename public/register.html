<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register — Beowulf</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="app">
    <script src="/js/layout.js"></script>

    <main class="main" style="max-width:640px;margin:28px auto;">
      <section class="card">
        <h2>Create account</h2>
        <p class="muted">Register to create teams and join contests.</p>

        <div style="margin-top:12px;">
          <label class="muted small">Display name</label>
          <input id="displayName" class="input" placeholder="Your name" />
        </div>

        <div style="margin-top:10px;">
          <label class="muted small">Email</label>
          <input id="email" class="input" placeholder="you@example.com" type="email" />
        </div>

        <div style="margin-top:10px;">
          <label class="muted small">Password</label>
          <input id="password" class="input" placeholder="Choose a password" type="password" />
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;align-items:center;">
          <button id="registerBtn" class="btn-primary">Register</button>
          <a href="/login.html" class="btn-ghost">Login</a>
          <div id="regMsg" class="muted small" style="margin-left:auto"></div>
        </div>
      </section>
    </main>
  </div>

<script>
  function setLocalToken(token){
    if (window.App && typeof App.setToken === 'function') {
      App.setToken(token);
    } else {
      localStorage.setItem('token', token);
    }
  }

  async function callRegister(displayName, email, password) {
    try {
      if (window.App && typeof App.post === 'function') {
        const r = await App.post('/api/auth/register', { displayName, email, password });
        return r;
      } else {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ displayName, email, password })
        });
        const j = await res.json();
        return { ok: res.ok && (j.ok || true), data: j, ...j };
      }
    } catch (err) {
      return { ok:false, error: err.message || 'Network' };
    }
  }

  document.getElementById('registerBtn').addEventListener('click', async () => {
    const displayName = document.getElementById('displayName').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    const msg = document.getElementById('regMsg');
    msg.textContent = '';

    if (!email || !password) { msg.textContent = 'Email and password required'; return; }

    msg.textContent = 'Registering…';

    const res = await callRegister(displayName, email, password);
    const payload = res?.data || res;

    if (res.ok && payload && (payload.ok || payload.token)) {
      const token = payload.token || payload.data?.token;
      setLocalToken(token);
      msg.textContent = 'Registered';
      setTimeout(()=> window.location = '/', 700);
      return;
    }

    const errMsg = payload?.error || payload?.message || res?.error || 'Registration failed';
    msg.textContent = errMsg;
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('registerBtn').click();
  });
</script>
</body>
</html>
