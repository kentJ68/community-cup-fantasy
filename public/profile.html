<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Profile • Beowulf Fantasy</title>

  <link rel="stylesheet" href="/css/style.css" />

  <style>
    .profile-card {
      max-width: 640px;
      margin: 0 auto;
    }

    .avatar-box {
      text-align: center;
      margin-bottom: 20px;
    }

    .avatar-pic {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 0 12px rgba(0,0,0,0.5);
    }

    .avatar-upload {
      margin-top: 10px;
      text-align: center;
    }

    .input {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      background: #0b141f;
      border: 1px solid #1e2f45;
      border-radius: 10px;
      color: #e2ecf5;
      font-size: 15px;
    }

    .btn-primary {
      width: 100%;
      margin-top: 16px;
    }

    .badge-tag {
      background: #1a2433;
      border: 1px solid #2f4157;
      padding: 4px 10px;
      border-radius: 8px;
      margin-right: 6px;
      display: inline-block;
      font-size: 12px;
      color: #a8c4e0;
    }
  </style>
</head>

<body>

<!-- Apply topbar + sidebar -->
<script src="/js/layout.js"></script>

<main class="main">

  <h2>Your Profile</h2>
  <p class="muted">Update your info, avatar, and track season progress.</p>

  <section class="card profile-card">

    <!-- AVATAR -->
    <div class="avatar-box">
      <img id="avatarImg" class="avatar-pic" src="/assets/default-avatar.png" alt="">
      <div class="avatar-upload">
        <input id="avatarFile" type="file" accept="image/*" style="margin-top:10px;">
        <button class="btn-ghost small" onclick="uploadAvatar()">Upload Avatar</button>
      </div>
    </div>

    <!-- DISPLAY NAME -->
    <label>Display Name</label>
    <input id="displayName" class="input" placeholder="Your name">

    <!-- EMAIL INFO -->
    <label style="margin-top:14px;">Email (read-only)</label>
    <input id="emailBox" class="input" disabled>

    <!-- FLAGS -->
    <div id="authFlags" style="margin-top:12px;"></div>

    <!-- SAVE BUTTON -->
    <button class="btn-primary" onclick="saveProfile()">Save Profile</button>

  </section>

  <!-- SEASON STATS -->
  <section class="card profile-card" style="margin-top:20px;">
    <h3>Your Season Progress</h3>
    <div id="seasonInfo" class="muted">Loading…</div>
  </section>

</main>


<script>
let USER = null;

// -----------------------------
// Load current profile
// -----------------------------
async function loadProfile() {
  const token = localStorage.getItem("token");
  if (!token) {
    window.location = "/login.html";
    return;
  }

  const r = await fetch("/api/me", {
    headers: { Authorization: "Bearer " + token }
  });

  const j = await r.json();

  if (!j.ok) {
    window.location = "/login.html";
    return;
  }

  USER = j.user;

  // Fill form
  document.getElementById("displayName").value = USER.displayName || "";
  document.getElementById("emailBox").value = USER.email || "Google-linked";

  if (USER.avatarUrl) {
    document.getElementById("avatarImg").src = USER.avatarUrl;
  }

  // Auth flags
  const flags = [];
  if (USER.googleId) flags.push(`<span class="badge-tag">Google Linked</span>`);
  if (USER.role === "admin") flags.push(`<span class="badge-tag">Admin</span>`);
  document.getElementById("authFlags").innerHTML = flags.join("");

  loadSeasonProgress();
}

loadProfile();


// -----------------------------
// Upload Avatar
// -----------------------------
async function uploadAvatar() {
  const f = document.getElementById("avatarFile").files[0];
  if (!f) return alert("Select an image first!");

  const form = new FormData();
  form.append("avatar", f);

  const token = localStorage.getItem("token");

  const r = await fetch("/api/me/avatar", {
    method: "POST",
    headers: { Authorization: "Bearer " + token },
    body: form
  });

  const j = await r.json();

  if (!j.ok) return alert("Upload failed");

  document.getElementById("avatarImg").src = j.avatarUrl;
  alert("Avatar updated!");
}


// -----------------------------
// Save Profile (Display Name)
// -----------------------------
async function saveProfile() {
  const newName = document.getElementById("displayName").value.trim();
  if (!newName) return alert("Name cannot be empty");

  const token = localStorage.getItem("token");

  const r = await fetch("/api/me", {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ displayName: newName })
  });

  const j = await r.json();

  if (!j.ok) {
    alert("Save failed");
  } else {
    alert("Profile updated!");
  }
}


// -----------------------------
// Season Progress
// -----------------------------
async function loadSeasonProgress() {
  const box = document.getElementById("seasonInfo");
  const token = localStorage.getItem("token");
  if (!token) {
    box.innerHTML = "Login required.";
    return;
  }

  // get displayName
  const name = USER.displayName;

  try {
    const r = await fetch("/api/season/leaderboard");
    const j = await r.json();

    if (!j.ok || !j.leaderboard.length) {
      box.innerHTML = "<div class='muted'>Season not started yet.</div>";
      return;
    }

    const rank = j.leaderboard.findIndex(x => x.viewerName === name);

    if (rank === -1) {
      box.innerHTML = `
        <div class="muted">You haven't participated yet.</div>
      `;
      return;
    }

    const total = j.leaderboard[rank].total;

    box.innerHTML = `
      <div style="margin-bottom:10px;">
        <strong>Rank:</strong> #${rank + 1}
      </div>
      <div style="margin-bottom:10px;">
        <strong>Total Points:</strong> ${total}
      </div>
    `;

  } catch (e) {
    box.innerHTML = "Failed to load season stats.";
  }
}

</script>

</body>
</html>
