<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard • Beowulf</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>

<!-- layout adds topbar + sidebar -->
<script src="/js/layout.js"></script>

<main class="main">
  <h2>Admin Dashboard</h2>
  <p class="muted">Quick admin tools — seed teams, manage contests, recompute season totals and export data.</p>

  <!-- ADMIN GUARD: if not admin, redirect to dashboard -->
  <script>
    (async function(){
      const adminToken = sessionStorage.getItem('adminToken') || localStorage.getItem('adminToken');
      if (adminToken === 'Ok12345') return;
      const token = localStorage.getItem('token');
      if (!token) { window.location = '/dashboard.html'; return; }
      try {
        const r = await fetch('/api/me', { headers:{ Authorization: 'Bearer ' + token }});
        const j = await r.json();
        if (!(j.ok && j.user && j.user.role === 'admin')) window.location = '/dashboard.html';
        // mark adminToken for convenience in admin pages
        sessionStorage.setItem('adminToken', 'Ok12345');
      } catch (e) { window.location = '/dashboard.html'; }
    })();
  </script>

  <!-- ROW: Quick Links -->
  <section class="card" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <div>
      <a class="btn-primary" href="/admin/matches.html">Manage Matches</a>
    </div>
    <div>
      <a class="btn-ghost" href="/admin-roster-generator.html">Roster Generator</a>
    </div>
    <div>
      <button class="btn-ghost" onclick="recomputeSeason()">Recompute Season Totals</button>
    </div>
    <div>
      <button class="btn-ghost" onclick="openSeedModal()">Seed League Teams</button>
    </div>
  </section>

  <!-- SEED TEAMS -->
  <section class="card">
    <h3>Seed League Teams (bulk)</h3>
    <div class="muted">Paste JSON array of teams. Each team object: <code>{ "name": "Lucknow Nawabs", "short":"LKN", "color":"#1a5cff", "logo":"https://...", "squad":[... ] }</code></div>

    <textarea id="seedJson" class="input" rows="6" placeholder='[ {"name":"Lucknow Nawabs","short":"LKN","color":"#1a5cff","logo":"","squad":["Rohit Sharma", "..."]} ]'></textarea>
    <div style="margin-top:10px;">
      <button class="btn-primary" onclick="seedTeams()">Seed Teams</button>
      <button class="btn-ghost" onclick="document.getElementById('seedJson').value = ''">Clear</button>
    </div>

    <div id="seedResult" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- CREATE CONTEST -->
  <section class="card">
    <h3>Create Contest for a Match</h3>
    <label>Match</label>
    <select id="contestMatch" class="input"></select>

    <label>Title</label>
    <input id="contestTitle" class="input" placeholder="Super Cash Blast">

    <label>Entry Fee</label>
    <input id="contestEntry" class="input" placeholder="e.g., 50">

    <label>Max Entries</label>
    <input id="contestMax" class="input" placeholder="e.g., 100">

    <div style="margin-top:10px;">
      <button class="btn-primary" onclick="createContest()">Create Contest</button>
    </div>

    <div id="contestResult" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- EXPORT TEAMS -->
  <section class="card">
    <h3>Export Teams (CSV)</h3>
    <label>Select Match</label>
    <select id="exportMatch" class="input"></select>
    <div style="margin-top:10px;">
      <button class="btn-primary" onclick="exportTeams()">Download CSV</button>
    </div>
    <div id="exportResult" class="muted" style="margin-top:8px;"></div>
  </section>

  <!-- RAW API Console (small) -->
  <section class="card">
    <h3>Quick API Console</h3>
    <div class="muted">Send a raw fetch to server (for debugging)</div>
    <label>Method & Path</label>
    <input id="apiPath" class="input" placeholder="POST /api/admin/matches">
    <textarea id="apiBody" class="input" rows="4" placeholder='{"name":"Test", "teamA":"A", "teamB":"B"}'></textarea>
    <div style="margin-top:8px;">
      <button class="btn-ghost" onclick="rawApi()">Send</button>
    </div>
    <pre id="apiResult" style="margin-top:8px;background:#0e1620;padding:10px;border-radius:8px;color:#cfe6ff;"></pre>
  </section>

</main>

<script>
const ADMIN_TOKEN = "Ok12345";

async function fillMatchSelectors() {
  try {
    const r = await fetch('/api/matches');
    const matches = await r.json();
    const cm = document.getElementById('contestMatch');
    const ex = document.getElementById('exportMatch');

    if (!matches || !matches.length) {
      cm.innerHTML = '<option>No matches</option>';
      ex.innerHTML = '<option>No matches</option>';
      return;
    }

    cm.innerHTML = matches.map(m => `<option value="${m._id}">${m.name}</option>`).join('');
    ex.innerHTML = matches.map(m => `<option value="${m._id}">${m.name}</option>`).join('');
  } catch (e) {
    console.error(e);
  }
}

fillMatchSelectors();

async function seedTeams() {
  const raw = document.getElementById('seedJson').value.trim();
  if (!raw) return alert('Paste teams JSON first.');

  let teams;
  try { teams = JSON.parse(raw); }
  catch(e) { return alert('Invalid JSON'); }

  const r = await fetch('/api/admin/league/teams/seed', {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'X-Admin-Token': ADMIN_TOKEN },
    body: JSON.stringify({ teams })
  });
  const j = await r.json();
  document.getElementById('seedResult').textContent = j.ok ? `Inserted ${j.inserted} teams` : `Error: ${j.error||'unknown'}`;
  fillMatchSelectors();
}

async function createContest() {
  const matchId = document.getElementById('contestMatch').value;
  const title = document.getElementById('contestTitle').value.trim();
  const entryFee = Number(document.getElementById('contestEntry').value || 0);
  const maxEntries = Number(document.getElementById('contestMax').value || 0);

  if (!matchId || !title) return alert('Match and title required');

  const r = await fetch(`/api/admin/matches/${matchId}/contests`, {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'X-Admin-Token': ADMIN_TOKEN },
    body: JSON.stringify({ title, entryFee, maxEntries })
  });

  const j = await r.json();
  document.getElementById('contestResult').textContent = j.ok ? 'Contest created' : `Error: ${j.error||'unknown'}`;
}

async function recomputeSeason() {
  if (!confirm('Recompute all team totals from match stats?')) return;
  const r = await fetch('/api/admin/season/recompute', {
    method:'POST',
    headers: { 'X-Admin-Token': ADMIN_TOKEN }
  });
  const j = await r.json();
  alert(j.ok ? `Recomputed ${j.updated} teams` : `Error: ${j.error||'unknown'}`);
}

function openSeedModal() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
  document.getElementById('seedJson').focus();
}

async function exportTeams() {
  const matchId = document.getElementById('exportMatch').value;
  if (!matchId) return alert('Select a match');

  const url = `/api/admin/matches/${matchId}/export-teams`;
  // download
  const a = document.createElement('a');
  a.href = url + `?adminToken=${ADMIN_TOKEN}`;
  a.download = `match-${matchId}-teams.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  document.getElementById('exportResult').textContent = 'Export started';
}

async function rawApi() {
  const path = document.getElementById('apiPath').value.trim();
  let body = document.getElementById('apiBody').value.trim();
  let method = 'GET';
  let url = path;

  if (!path) return alert('Enter path like: POST /api/admin/matches');

  const parts = path.split(' ');
  if (parts.length === 2) {
    method = parts[0].toUpperCase();
    url = parts[1];
  }

  try {
    const opts = { method, headers: {} };
    if (method !== 'GET' && body) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = body;
    }
    // attach admin token automatically
    opts.headers['X-Admin-Token'] = ADMIN_TOKEN;

    const r = await fetch(url, opts);
    const text = await r.text();
    document.getElementById('apiResult').textContent = text;
  } catch (e) {
    document.getElementById('apiResult').textContent = 'Error: ' + e.message;
  }
}
</script>

</body>
</html>
