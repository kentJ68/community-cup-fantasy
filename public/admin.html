<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin – Community Cup Fantasy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial;background:#020617;color:#eef;margin:0;padding:16px}
    .card{max-width:820px;margin:10px auto;background:#021021;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    input,textarea,select{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #253246;background:#020617;color:#eef}
    button{padding:10px 14px;border-radius:999px;border:none;background:#22c55e;color:#022c22;font-weight:700;cursor:pointer;margin-top:8px}
    h1{margin:0 0 8px}
    textarea{min-height:120px;font-family:monospace}
    .small{opacity:0.8;font-size:0.9rem}
    .row{display:flex;gap:8px}
    .col{flex:1}
    label{margin-top:10px;display:block}
  </style>
</head>
<body>
  <div class="card">
    <h1>Admin Panel</h1>
    <p class="small">Make sure you've set <code>ADMIN_TOKEN</code> in .env. Use the token field below to authorize actions.</p>

    <label>Admin token</label>
    <input id="adminToken" placeholder="Paste admin token here (for this session)" />

    <h3>Create Match</h3>
    <input id="matchName" placeholder="Match name e.g. Match 1 – Firestorm vs Uttarakhand" />
    <div class="row">
      <div class="col"><button id="createMatchBtn">Create Match</button></div>
      <div class="col"><div id="createMsg" class="small"></div></div>
    </div>

    <hr/>

    <h3>Update Stats for Match</h3>
    <label>Select Match</label>
    <select id="matchSelect"></select>

    <label>Stats JSON (array of player objects)</label>
    <textarea id="statsJson" placeholder='[{"playerName":"RUSSELL","runs":45,"fours":4,"sixes":1,"wickets":0,"maidens":0,"catches":1}]'></textarea>
    <div class="row">
      <div class="col"><button id="updateStatsBtn">Save Stats</button></div>
      <div class="col"><div id="statsMsg" class="small"></div></div>
    </div>
<label>Or upload scorecard image (screenshot)</label>
<input type="file" id="scorecardImage" accept="image/*" />
<button id="uploadOCRBtn">Upload & Parse Image</button>
<div id="ocrResult" class="small"></div>

    <hr/>



    <h3>Debug / Quick Operations</h3>
    <div class="row">
      <div class="col"><button id="listMatchesBtn">Reload Matches</button></div>
      <div class="col"><button id="refreshMsgBtn">Ping Health</button></div>
    </div>
    <div id="debugOut" class="small" style="margin-top:8px"></div>
  </div>

  <script>
    async function loadMatches() {
      const sel = document.getElementById('matchSelect');
      sel.innerHTML = '<option>Loading...</option>';
      try {
        const res = await fetch('/api/matches');
        const matches = await res.json();
        sel.innerHTML = '';
        if (!Array.isArray(matches) || matches.length === 0) {
          sel.innerHTML = '<option>No matches</option>';
          return;
        }
        matches.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m._id;
          opt.textContent = m.name;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        sel.innerHTML = '<option>Failed to load</option>';
      }
    }

    async function createMatch() {
      const name = document.getElementById('matchName').value.trim();
      const token = document.getElementById('adminToken').value.trim();
      const msg = document.getElementById('createMsg');
      msg.textContent = '';
      if (!name) { msg.textContent = 'Enter a name'; return; }
      try {
        const res = await fetch('/api/matches?adminToken=' + encodeURIComponent(token), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, date: new Date() })
        });
        const data = await res.json();
        if (!res.ok) {
          msg.textContent = data.error || 'Failed';
        } else {
          msg.textContent = 'Match created';
          loadMatches();
        }
      } catch (e) {
        console.error(e);
        msg.textContent = 'Network error';
      }
    }
document.getElementById('uploadOCRBtn').addEventListener('click', async () => {
  const file = document.getElementById('scorecardImage').files[0];
  const matchId = document.getElementById('matchSelect').value;
  const token = document.getElementById('adminToken').value.trim();
  const out = document.getElementById('ocrResult');
  out.textContent = '';
  if (!file || !matchId) { out.textContent = 'Select match and image first'; return; }
  const fd = new FormData();
  fd.append('image', file);

  try {
    const res = await fetch(`/api/admin/ocr-scorecard/${matchId}?adminToken=${encodeURIComponent(token)}`, { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) {
      out.textContent = 'OCR failed: ' + (data.error || 'unknown');
      console.error(data);
      return;
    }
    // show parsed stats pretty
    out.textContent = 'Parsed ' + (data.stats?.length||0) + ' players. Click Save Stats to confirm.';
    // populate statsJson textarea so admin can review then click Save Stats
    document.getElementById('statsJson').value = JSON.stringify(data.stats, null, 2);
  } catch (e) {
    console.error(e);
    out.textContent = 'Network error';
  }
});

    async function updateStats() {
      const matchId = document.getElementById('matchSelect').value;
      const token = document.getElementById('adminToken').value.trim();
      const msg = document.getElementById('statsMsg');
      msg.textContent = '';
      let stats;
      try {
        stats = JSON.parse(document.getElementById('statsJson').value);
      } catch (e) {
        msg.textContent = 'Invalid JSON';
        return;
      }
      try {
        const res = await fetch(`/api/matches/${matchId}/stats?adminToken=` + encodeURIComponent(token), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stats })
        });
        const data = await res.json();
        if (!res.ok) msg.textContent = data.error || 'Failed';
        else { msg.textContent = 'Stats updated'; }
      } catch (e) {
        console.error(e);
        msg.textContent = 'Network error';
      }
    }

    document.getElementById('createMatchBtn').addEventListener('click', createMatch);
    document.getElementById('updateStatsBtn').addEventListener('click', updateStats);
    document.getElementById('listMatchesBtn').addEventListener('click', loadMatches);
    document.getElementById('refreshMsgBtn').addEventListener('click', async () => {
      try {
        const res = await fetch('/api/health'); const d = await res.json(); document.getElementById('debugOut').textContent = JSON.stringify(d);
      } catch (e) { document.getElementById('debugOut').textContent = 'Error'; }
    });

    loadMatches();
  </script>
</body>
</html>
