
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard • Beowulf Community Cup Fantasy</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="app">
    <script src="/js/layout.js"></script>

    <main class="main">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2>Match Leaderboard</h2>
            <div class="muted">Click a row to view the full team (captain/vice highlighted).</div>
          </div>
          <div>
            <a class="btn-ghost" href="/">Back</a>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
          <select id="matchSelect" class="input" style="min-width:320px"></select>
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>

        <div id="board" style="margin-top:16px">
          <div class="muted">Loading leaderboard…</div>
        </div>
      </section>
    </main>
  </div>

  <!-- View Team Modal (Option A) -->
  <div id="teamModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center">
    <div style="max-width:760px;margin:auto;background:#0f1116;padding:18px;border-radius:10px">
      <div style="display:flex;align-items:center;gap:12px">
        <img id="modalAvatar" src="/assets/avatars/default.png" style="width:64px;height:64px;border-radius:8px;object-fit:cover" />
        <div style="flex:1">
          <div id="modalTeamName" style="font-weight:800;font-size:18px">Team</div>
          <div id="modalViewerName" class="muted small">by viewer</div>
        </div>
        <div style="text-align:right">
          <div id="modalScore" style="font-weight:800">0 pts</div>
          <div id="modalMeta" class="muted small"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:700">Players</div>
        <div id="modalPlayers" style="margin-top:8px"></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="modalClose" class="btn-ghost">Close</button>
        <button id="modalDelete" class="btn" style="background:#ff6b6b;display:none">Delete team</button>
      </div>
    </div>
  </div>

<script>
/*
  leaderboard.html
  - View modal shows avatar (viewer avatar if available) - Option A + L
  - Dedupe entries by teamId / viewerName
*/
const $ = id => document.getElementById(id);
function preferGet(path){ if (window.App && typeof App.get === 'function') { return App.get(path).catch(()=>fetch(path).then(r=>r.json())); } return fetch(path).then(r=>r.json()); }
function apiGet(path){ return preferGet(path); }
function apiAuth(path, init={}) { init.headers = init.headers || {}; const t = localStorage.getItem('token'); if (t) init.headers['Authorization'] = 'Bearer ' + t; return fetch(path, init).then(r=>r.json().catch(()=>({ok:false}))); }

function qparam(k){ const u = new URLSearchParams(location.search); return u.get(k) || (k==='match'?u.get('match'):null); }

let MATCHES = [], CURRENT = null, ENRICHED = [];

async function loadMatches(){
  $('matchSelect').innerHTML = '<option>Loading matches…</option>';
  try {
    const matches = await apiGet('/api/matches');
    MATCHES = Array.isArray(matches) ? matches.filter(m=>!m.archived) : [];
    MATCHES.sort((a,b)=> new Date(a.startTime||0) - new Date(b.startTime||0));
    if (!MATCHES.length) { $('matchSelect').innerHTML = '<option>No matches</option>'; return; }
    $('matchSelect').innerHTML = MATCHES.map(m => `<option value="${m._id}">${m.name || (m.teamA+' vs '+m.teamB)} — ${m.startTime?new Date(m.startTime).toLocaleString():'TBD'}</option>`).join('');
    const q = qparam('match') || qparam('matchId');
    let sel = 0;
    if (q) {
      const idx = MATCHES.findIndex(x => String(x._id) === String(q));
      if (idx !== -1) sel = idx;
    }
    $('matchSelect').selectedIndex = sel; CURRENT = MATCHES[sel];
    await refreshBoard();
  } catch (e) { console.error(e); $('matchSelect').innerHTML = '<option>Error</option>'; }
}
$('matchSelect').addEventListener('change', ()=> { CURRENT = MATCHES[$('matchSelect').selectedIndex]; refreshBoard(); });
$('refreshBtn').addEventListener('click', ()=> refreshBoard());

async function refreshBoard(){
  const board = $('board'); board.innerHTML = '<div class="muted">Loading leaderboard…</div>';
  if (!CURRENT) return board.innerHTML = '<div class="muted">Select a match</div>';
  try {
    const lb = await apiGet(`/api/matches/${CURRENT._id}/leaderboard`);
    const teamsResp = await apiGet(`/api/matches/${CURRENT._id}/teams`);
    const leaderboard = Array.isArray(lb) ? lb : (lb.leaderboard || []);
    const teams = Array.isArray(teamsResp) ? teamsResp : (teamsResp.teams || []);
    const map = new Map(); teams.forEach(t => map.set(String(t._id), t));

    ENRICHED = leaderboard.map(e => {
      const teamId = e.teamId || e.team || e._id || null;
      return Object.assign({}, e, { teamObj: map.get(String(teamId)) || null });
    });

    // include teams not in leaderboard
    teams.forEach(t => {
      const exists = ENRICHED.some(x => String(x.teamId) === String(t._id) || (x.teamObj && String(x.teamObj._id) === String(t._id)));
      if (!exists) ENRICHED.push({ teamId: t._id, name: t.name || t.viewerName || `Team ${t._id}`, total: t.totalPoints || 0, teamObj: t });
    });

    // dedupe: prefer teamId, fallback to viewerName
    const seen = new Set(); const dedup = [];
    for (const e of ENRICHED) {
      const teamId = e.teamId || (e.teamObj && (e.teamObj._id || e.teamObj.id));
      const viewer = (e.teamObj && e.teamObj.viewerName) || e.viewerName || e.name;
      const key = teamId ? `id:${String(teamId)}` : `viewer:${String((viewer||'').toLowerCase())}`;
      if (seen.has(key)) continue;
      seen.add(key); dedup.push(e);
    }
    ENRICHED = dedup;

    ENRICHED.sort((a,b)=> (b.total || b.totalPoints || 0) - (a.total || a.totalPoints || 0));
    renderBoard();
  } catch (err) { console.error(err); board.innerHTML = '<div class="muted">Failed to load leaderboard</div>'; }
}

function renderBoard(){
  const board = $('board'); board.innerHTML = '';
  if (!ENRICHED.length) { board.innerHTML = '<div class="muted">No teams yet</div>'; return; }
  ENRICHED.forEach((r,i)=>{
    const pos = i+1;
    const teamObj = r.teamObj;
    const teamName = teamObj ? (teamObj.name || teamObj.viewerName) : (r.name || `Team ${pos}`);
    const viewer = teamObj ? teamObj.viewerName : (r.viewerName || '');
    const score = (r.total != null) ? r.total : (r.totalPoints != null ? r.totalPoints : 0);
    const el = document.createElement('div');
    el.className = 'card';
    el.style.display = 'flex'; el.style.justifyContent = 'space-between'; el.style.alignItems = 'center'; el.style.marginBottom = '10px';
    el.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:48px;font-weight:800;color:#2b6cff">#${pos}</div>
        <div style="width:64px;height:64px;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#5b1f1f;color:#fff;font-weight:700">
          ${initials(teamName||viewer)}
        </div>
        <div style="flex:1"><div style="font-weight:700">${escapeHtml(teamName)} <span class="muted small">— ${escapeHtml(viewer)}</span></div></div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800">${escapeHtml(String(score))} pts</div>
        <div style="margin-top:8px"><button class="btn-ghost" data-idx="${i}">View</button></div>
      </div>`;
    board.appendChild(el);
  });
  document.querySelectorAll('.btn-ghost[data-idx]').forEach(b => b.addEventListener('click', (ev) => openModal(Number(ev.currentTarget.dataset.idx))));
}

function initials(name){ if(!name) return 'U'; const p = name.trim().split(/\s+/); return p.length===1 ? (p[0][0]||'').toUpperCase() : ((p[0][0]||'')+(p[1][0]||'')).toUpperCase(); }
function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

async function openModal(idx){
  const entry = ENRICHED[idx]; if (!entry) return;
  const team = entry.teamObj || { _id: entry.teamId, name: entry.name, viewerName: entry.viewerName, players: [], captain: entry.captain, vice: entry.vice, createdAt: entry.createdAt };

  // try to show viewer avatar (L). If teamObj has avatar use it; else fetch /api/me if owner
  let avatar = '/assets/avatars/default.png';
  if (team.teamLogo) avatar = team.teamLogo;
  else if (team.avatarUrl) avatar = team.avatarUrl;
  else if (team.viewerName) {
    // attempt to fetch user by displayName? If your server exposes user profiles we could fetch. Fallback to /api/me if current user owns it.
    try {
      const me = await apiAuth('/api/me');
      if (me && me.ok && me.user && me.user.displayName === team.viewerName && me.user.avatarUrl) avatar = me.user.avatarUrl;
    } catch {}
  }
  $('modalAvatar').src = avatar;
  $('modalTeamName').textContent = team.name || (team.viewerName ? team.viewerName + "'s Team" : 'Team');
  $('modalViewerName').textContent = team.viewerName || '';
  $('modalScore').textContent = ((entry.total != null) ? entry.total : (entry.totalPoints != null ? entry.totalPoints : 0)) + ' pts';
  $('modalMeta').textContent = team.createdAt ? new Date(team.createdAt).toLocaleString() : '';

  const players = team.players || [];
  const captain = team.captain || '';
  const vice = team.vice || '';
  $('modalPlayers').innerHTML = players.length ? players.map((p,i)=> `<div style="padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02)">${i+1}. ${escapeHtml(p)} ${p===captain?'<strong>(C)</strong>':''} ${p===vice?'<strong>(VC)</strong>':''}</div>`).join('') : '<div class="muted small">No players visible</div>';

  $('teamModal').style.display = 'flex';

  // show delete button if owner
  (async function(){
    const btn = $('modalDelete'); btn.style.display = 'none';
    try {
      const me = await apiAuth('/api/me');
      if (me && me.ok && me.user && me.user.displayName && team.viewerName && me.user.displayName === team.viewerName) {
        btn.style.display = 'inline-block';
        btn.onclick = async () => {
          if (!confirm('Delete your team?')) return;
          try {
            const res = await apiAuth(`/api/matches/${CURRENT._id}/teams/${team._id}`, { method: 'DELETE' });
            if (res && (res.ok || res.success)) { alert('Deleted'); closeModal(); refreshBoard(); } else alert('Delete failed: ' + (res && res.error || JSON.stringify(res)));
          } catch (e) { console.error(e); alert('Delete failed'); }
        };
      }
    } catch(e){ console.warn(e); }
  })();
}

$('modalClose').addEventListener('click', closeModal);
function closeModal(){ $('teamModal').style.display = 'none'; }
async function apiAuth(path, init={}) { init.headers = init.headers || {}; const t = localStorage.getItem('token'); if (t) init.headers['Authorization'] = 'Bearer ' + t; return fetch(path, init).then(r=>r.json().catch(()=>({ok:false}))); }

(async function init(){ await loadMatches(); try { if (window.App && typeof App.init === 'function') App.init(); } catch(e){} })();
</script>
</body>
</html>
