<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Leaderboard â€¢ Beowulf Fantasy League</title>

  <link rel="stylesheet" href="/css/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>

<!-- GLOBAL LAYOUT SYSTEM -->
<script src="/js/layout.js"></script>

<main class="main">

  <h2>Match Leaderboard</h2>
  <p class="muted">Track who is leading this match in real time.</p>

  <!-- SELECT MATCH -->
  <section class="card">
    <label>Select Match</label>
    <select id="matchSelect" class="input"></select>
  </section>

  <!-- LEADERBOARD -->
  <section class="card">
    <h3>Leaderboard</h3>
    <div id="leaderData" class="muted">Select a match to view leaderboard.</div>
  </section>

</main>

<script>
// Load matches for dropdown
(async function loadMatches() {
  const r = await fetch("/api/matches");
  const matches = await r.json();

  const el = document.getElementById("matchSelect");

  if (!matches.length) {
    el.innerHTML = "<option>No matches found</option>";
    return;
  }

  el.innerHTML = matches.map(m => `
    <option value="${m._id}">${m.name}</option>
  `).join("");

  loadLeaderboard(matches[0]._id);

  el.addEventListener("change", () => {
    loadLeaderboard(el.value);
  });
})();


// Load leaderboard for match
async function loadLeaderboard(matchId) {
  const box = document.getElementById("leaderData");

  try {
    const r = await fetch(`/api/matches/${matchId}/leaderboard`);
    const j = await r.json();

    if (!j.ok || j.leaderboard.length === 0) {
      box.innerHTML = "<div class='muted'>No leaderboard for this match yet.</div>";
      return;
    }

    box.innerHTML = j.leaderboard.map((row, i) => `
      <div class="leader-row">
        <div class="leader-rank">#${i + 1}</div>
        <div class="leader-user">
          <strong>${row.name || row.viewerName}</strong>
        </div>
        <div class="leader-points">${row.total} pts</div>
      </div>
    `).join("");

  } catch (err) {
    console.error(err);
    box.innerHTML = "<div class='muted'>Unable to load leaderboard</div>";
  }
}

// Real-time updates via socket
const socket = io();
socket.on("leaderboardUpdate", payload => {
  const current = document.getElementById("matchSelect").value;
  if (current === payload.matchId) {
    loadLeaderboard(payload.matchId);
  }
});
</script>

</body>
</html>
