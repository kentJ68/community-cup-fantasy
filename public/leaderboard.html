<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Community Cup Fantasy â€“ Leaderboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial;background:#020617;color:#f8fafc;margin:0;padding:14px}
    .card{max-width:900px;margin:8px auto;background:#021021;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    h1{text-align:center;margin:0}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
    th{font-size:0.85rem;opacity:0.8;text-transform:uppercase}
    tr:nth-child(1){background:rgba(250,204,21,0.12)}
    tr:nth-child(2){background:rgba(148,163,184,0.08)}
    tr:nth-child(3){background:rgba(248,113,113,0.06)}
    .big {font-size:1.2rem;font-weight:700}
    .small{font-size:0.9rem;opacity:0.8}
    select{padding:8px;border-radius:8px;border:1px solid #273244;background:#020617;color:#f8fafc}
    .obs-small{font-size:0.95rem}
  </style>
</head>
<body>
  <div class="card">
    <h1>Fantasy Leaderboard</h1>
    <div style="margin-top:8px">
      Match:
      <select id="matchSelect"></select>
      <span id="matchInfo" class="small"></span>
    </div>

    <table id="board">
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th>Viewer</th>
          <th>Handle</th>
          <th style="width:120px">Points</th>
          <th>Top Picks</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="small">Auto-refresh every 10s. Use this page as an OBS browser source (set width/height for your scene).</p>
  </div>

  <script>
    async function loadMatches() {
      const sel = document.getElementById('matchSelect');
      sel.innerHTML = '<option>Loading...</option>';
      try {
        const res = await fetch('/api/matches');
        const matches = await res.json();
        sel.innerHTML = '';
        if (!Array.isArray(matches) || matches.length === 0) {
          sel.innerHTML = '<option>No matches</option>';
          return;
        }
        matches.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m._id;
          opt.textContent = m.name;
          sel.appendChild(opt);
        });
        loadLeaderboard();
      } catch (e) {
        console.error(e);
        sel.innerHTML = '<option>Failed</option>';
      }
    }

    async function loadLeaderboard() {
      const matchId = document.getElementById('matchSelect').value;
      const tbody = document.querySelector('#board tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
      if (!matchId) return;
      try {
        const res = await fetch(`/api/matches/${matchId}/leaderboard`);
        const data = await res.json();
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="5">${data.error || 'Failed to load'}</td></tr>`;
          return;
        }
        const lb = data.leaderboard || [];
        document.getElementById('matchInfo').textContent = ' â€¢ ' + (data.match?.name || '');
        if (lb.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No entries yet.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        lb.forEach((row, i) => {
          const medal = i===0 ? 'ðŸ¥‡' : i===1 ? 'ðŸ¥ˆ' : i===2 ? 'ðŸ¥‰' : (i+1);
          const topPicks = (row.breakdown || []).slice(0,3).map(b => `${b.player}${b.isCaptain?' (C)':''}: ${b.applied}`).join(' â€¢ ');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${medal}</td>
                          <td class="big">${row.viewerName}</td>
                          <td class="small">${row.handle || '-'}</td>
                          <td class="big">${row.total}</td>
                          <td class="small">${topPicks}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="5">Network error</td></tr>';
      }
    }

    document.getElementById('matchSelect').addEventListener('change', loadLeaderboard);
    loadMatches();
    setInterval(loadLeaderboard, 10000);
  </script>
</body>
</html>
