<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Team • Beowulf Fantasy</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .players-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:8px; }
    .player-chip { padding:8px; border-radius:8px; background:var(--card); display:flex; justify-content:space-between; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; }
    .muted { color:var(--muted); }
    .small { font-size:0.9rem; }
    .error { color:#f44; }
  </style>
</head>
<body>
  <div class="app">
    <script src="/js/layout.js"></script>

    <main class="main">
      <section class="card">
        <h2>Create Team</h2>
        <p class="muted small">Build your XI for the match. You must be logged in to create a team.</p>

        <div style="margin-top:12px;">
          <label>Match</label>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
            <select id="matchSelect" class="input" style="flex:1"></select>
            <div id="matchInfo" class="muted small" style="min-width:220px;text-align:right;"></div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>Your display name</label>
          <input id="viewerName" class="input" placeholder="Viewer name (from profile)" />
          <div class="muted small">This is used to link your team. If empty you'll be asked to login.</div>
        </div>

        <div style="margin-top:12px;">
          <label>Players (click to toggle select)</label>
          <div id="playersGrid" class="players-grid" style="margin-top:8px;"></div>
          <div class="muted small" style="margin-top:8px">Selected: <span id="selectedCount">0</span>/11</div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          <div style="flex:1">
            <label>Captain</label>
            <select id="captainSelect" class="input"></select>
          </div>
          <div style="flex:1">
            <label>Vice</label>
            <select id="viceSelect" class="input"></select>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="submitTeam" class="btn btn-primary">Create Team</button>
          <button id="saveDraft" class="btn btn-ghost">Save Draft</button>
          <div id="msg" class="muted small" style="margin-left:8px"></div>
        </div>

        <div id="errorBox" class="error small" style="margin-top:10px;display:none"></div>
      </section>
    </main>
  </div>

<script>
(async function(){
  const matchSelect = document.getElementById('matchSelect');
  const matchInfo = document.getElementById('matchInfo');
  const playersGrid = document.getElementById('playersGrid');
  const selectedCountEl = document.getElementById('selectedCount');
  const captainSelect = document.getElementById('captainSelect');
  const viceSelect = document.getElementById('viceSelect');
  const viewerNameInput = document.getElementById('viewerName');
  const submitBtn = document.getElementById('submitTeam');
  const saveDraftBtn = document.getElementById('saveDraft');
  const msg = document.getElementById('msg');
  const errorBox = document.getElementById('errorBox');

  let ALL_PLAYERS = [];      // available players for the match
  const chosenXI = [];       // player names
  let selectedMatch = null;  // match id

  // helper
  function q(s){ return document.querySelector(s); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function showError(text){ errorBox.style.display = text ? 'block' : 'none'; errorBox.textContent = text || ''; }
  function setMsg(t){ msg.textContent = t || ''; }

  // Read ?match=<id> fallback
  const urlParams = new URLSearchParams(location.search);
  const initialMatchId = urlParams.get('match');
  // load matches to allow admin pick or if not provided
  async function loadMatches(){
    try {
      const res = await fetch('/api/matches');
      const arr = await res.json();
      matchSelect.innerHTML = '<option value="">Select match...</option>';
      arr.sort((a,b)=> (new Date(a.startTime||0) - new Date(b.startTime||0)));
      arr.forEach(m => {
        const title = m.name || ((m.teamA||'') + ' vs ' + (m.teamB||''));
        const opt = document.createElement('option');
        opt.value = m._id;
        opt.textContent = `${title} • ${m.startTime ? new Date(m.startTime).toLocaleString() : '—'}`;
        matchSelect.appendChild(opt);
      });
      if (initialMatchId) {
        matchSelect.value = initialMatchId;
        matchSelect.dispatchEvent(new Event('change'));
      }
    } catch (e) {
      console.error('loadMatches', e);
    }
  }

  matchSelect.addEventListener('change', async (e) => {
    selectedMatch = e.target.value || null;
    matchInfo.textContent = selectedMatch ? 'Loading players…' : '';
    ALL_PLAYERS = [];
    chosenXI.length = 0;
    await loadPlayersForMatch(selectedMatch);
    renderPlayersGrid();
    renderCaptViceOptions();
    updateSelectedCount();
  });

  // load players of a match
  async function loadPlayersForMatch(matchId){
    if (!matchId) { playersGrid.innerHTML = '<div class="muted">Select a match</div>'; return; }
    try {
      const res = await fetch(`/api/matches/${matchId}/players`);
      const j = await res.json();
      if (!j.ok) { playersGrid.innerHTML = '<div class="muted">Failed to load players</div>'; return; }
      ALL_PLAYERS = j.players || [];
      playersGrid.innerHTML = '';
      matchInfo.textContent = `${ALL_PLAYERS.length} players loaded`;
      renderPlayersGrid();
    } catch (err) {
      console.error('loadPlayersForMatch', err);
      playersGrid.innerHTML = '<div class="muted">Error loading players</div>';
    }
  }

  function renderPlayersGrid(){
    playersGrid.innerHTML = '';
    ALL_PLAYERS.forEach(p => {
      const name = (p.playerName || p.player || p) ;
      const div = document.createElement('div');
      div.className = 'player-chip';
      div.innerHTML = `<span>${escapeHtml(name)}</span><button class="btn btn-ghost small">Add</button>`;
      const btn = div.querySelector('button');
      btn.addEventListener('click', () => {
        toggleSelectPlayer(name, btn);
      });
      // mark if selected
      if (chosenXI.includes(name)) btn.textContent = 'Remove';
      playersGrid.appendChild(div);
    });
    renderCaptViceOptions();
  }

  function toggleSelectPlayer(name, btnEl){
    const idx = chosenXI.indexOf(name);
    if (idx === -1) {
      if (chosenXI.length >= 11) { alert('You can only select 11 players'); return; }
      chosenXI.push(name);
      btnEl.textContent = 'Remove';
    } else {
      chosenXI.splice(idx,1);
      btnEl.textContent = 'Add';
    }
    renderCaptViceOptions();
    updateSelectedCount();
  }

  function renderCaptViceOptions(){
    const opts = ['<option value="">--</option>'];
    chosenXI.forEach(p => opts.push(`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`));
    captainSelect.innerHTML = opts.join('');
    viceSelect.innerHTML = opts.join('');
  }

  function updateSelectedCount(){
    selectedCountEl.textContent = String(chosenXI.length);
  }

  // load profile to prefill viewerName
  async function loadProfile(){
    const token = localStorage.getItem('token');
    if (!token) { setMsg('Not logged in — please log in to create a team'); return; }
    try {
      const r = await fetch('/api/me', { headers: { Authorization: 'Bearer ' + token }});
      if (!r.ok) { setMsg('Failed to fetch profile — please login again'); return; }
      const j = await r.json();
      if (j && j.ok && j.user) {
        viewerNameInput.value = j.user.displayName || j.user.email || '';
        setMsg(`Logged as ${viewerNameInput.value}`);
      } else {
        setMsg('Profile unavailable');
      }
    } catch (e) {
      console.warn('loadProfile', e);
      setMsg('Profile load error');
    }
  }

  // choose best contest after create
  async function findBestContestAndRedirect(matchId) {
    try {
      const r = await fetch(`/api/matches/${matchId}/contests`, { headers: { 'Content-Type': 'application/json' }});
      if (!r.ok) { window.location.href = `/contests.html?match=${encodeURIComponent(matchId)}`; return; }
      const list = await r.json();
      if (!Array.isArray(list) || list.length === 0) {
        window.location.href = `/contests.html?match=${encodeURIComponent(matchId)}`; return;
      }
      // pick first non-closed, not full, where viewer hasn't exhausted perViewerLimit
      const viewer = viewerNameInput.value && viewerNameInput.value.trim();
      let pick = null;
      for (const c of list) {
        if (c.closed) continue;
        const entryCount = typeof c.entryCount === 'number' ? c.entryCount : (c.entryCount || 0);
        const maxEntries = c.maxEntries || 0;
        if (maxEntries && entryCount >= maxEntries) continue;
        if (viewer && c.perViewerLimit) {
          const myEntries = c.myEntries || 0;
          if (myEntries >= c.perViewerLimit) continue;
        }
        pick = c; break;
      }
      if (pick) {
        window.location.href = `/contests.html?match=${encodeURIComponent(matchId)}&contest=${encodeURIComponent(pick._id)}`;
      } else {
        window.location.href = `/contests.html?match=${encodeURIComponent(matchId)}`;
      }
    } catch (e) {
      console.warn('findBestContestAndRedirect', e);
      window.location.href = `/contests.html?match=${encodeURIComponent(matchId)}`;
    }
  }

  // submit team
  submitBtn.addEventListener('click', async () => {
    showError('');
    setMsg('');
    if (!selectedMatch) { showError('Select a match'); return; }
    if (chosenXI.length !== 11) { showError('You must select exactly 11 players'); return; }
    const captain = captainSelect.value || null;
    const vice = viceSelect.value || null;
    if (!captain) { showError('Select a captain'); return; }
    if (!vice) { showError('Select a vice'); return; }
    const token = localStorage.getItem('token');
    if (!token) { showError('Not logged in. Please login to create a team.'); return; }

    // fetch viewer profile to ensure token valid and get viewerName
    let viewerName = viewerNameInput.value && viewerNameInput.value.trim();
    try {
      const rme = await fetch('/api/me', { headers: { Authorization: 'Bearer ' + token }});
      if (!rme.ok) { showError('Unauthorized. Please login again.'); return; }
      const jm = await rme.json();
      if (jm && jm.ok && jm.user) {
        viewerName = jm.user.displayName || jm.user.email || viewerName || '';
      }
    } catch (e) {
      console.warn('profile check failed', e);
    }
    if (!viewerName) { showError('Viewer name unavailable — ensure your profile has a displayName'); return; }

    // send create
    const payload = {
      players: chosenXI,
      captain,
      vice,
      name: `${viewerName}'s Team`
    };

    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating…';
    try {
      const res = await fetch(`/api/matches/${encodeURIComponent(selectedMatch)}/teams`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (res.ok && j && j.ok) {
        setMsg('Team created successfully — redirecting to contest…');
        // auto-redirect to best contest
        await findBestContestAndRedirect(selectedMatch);
        return;
      } else {
        const err = (j && (j.error || j.message)) || `HTTP ${res.status}`;
        showError('Create failed: ' + err);
        // If 401 -> clear token
        if (res.status === 401) localStorage.removeItem('token');
      }
    } catch (e) {
      console.error('create team request failed', e);
      showError('Create request failed: ' + (e.message || e));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create Team';
    }
  });

  // Save draft (localStorage)
  saveDraftBtn.addEventListener('click', () => {
    const draft = { matchId: selectedMatch, chosenXI, captain: captainSelect.value, vice: viceSelect.value, name: viewerNameInput.value };
    localStorage.setItem('teamDraft_' + (selectedMatch||'none'), JSON.stringify(draft));
    setMsg('Draft saved locally');
  });

  // load draft if present
  function loadDraftForMatch(matchId){
    try {
      const raw = localStorage.getItem('teamDraft_' + (matchId||'none'));
      if (!raw) return;
      const d = JSON.parse(raw);
      if (!d) return;
      if (Array.isArray(d.chosenXI)) {
        chosenXI.length = 0;
        d.chosenXI.slice(0,11).forEach(x => chosenXI.push(x));
      }
      setTimeout(() => { renderPlayersGrid(); renderCaptViceOptions(); updateSelectedCount(); }, 100);
      if (d.captain) captainSelect.value = d.captain;
      if (d.vice) viceSelect.value = d.vice;
      if (d.name) viewerNameInput.value = d.name;
      setMsg('Draft loaded');
    } catch (e){ /* ignore */ }
  }

  // init
  await loadMatches();
  if (initialMatchId) {
    // loadPlayersForMatch called by matchSelect change handler
  } else {
    // If only one upcoming match, auto-select it
    const sel = matchSelect.querySelectorAll('option');
    if (sel.length === 2) { matchSelect.selectedIndex = 1; matchSelect.dispatchEvent(new Event('change')); }
  }
  await loadProfile();

  // after players load, try load draft
  setTimeout(()=> loadDraftForMatch(matchSelect.value), 400);

})();
</script>
</body>
</html>
