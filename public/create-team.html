<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Team • Beowulf Fantasy League</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>

<!-- GLOBAL LAYOUT -->
<script src="/js/layout.js"></script>

<main class="main">

  <h2>Create Your Fantasy Team</h2>
  <p class="muted">Pick 11 players, choose captain and vice-captain, and join contests.</p>

  <!-- MATCH SELECTION -->
  <section class="card">
    <label for="matchSelect">Select Match</label>
    <select id="matchSelect" class="input"></select>
  </section>

  <!-- PLAYER SEARCH -->
  <section class="card">
    <label>Search Player</label>
    <input type="text" class="input" id="playerSearch" placeholder="Search by name or role…">
  </section>

  <!-- PLAYER LIST -->
  <section class="card">
    <h3>Available Players</h3>
    <div id="playersList" class="muted">Select a match</div>
  </section>

  <!-- SELECTED TEAM -->
  <section class="card">
    <h3>Your XI</h3>
    <div id="yourTeam"></div>

    <div style="margin-top:14px;">
      <label>Captain</label>
      <select id="captainSelect" class="input"></select>

      <label>Vice-Captain</label>
      <select id="viceSelect" class="input"></select>
    </div>

    <button id="submitTeam" class="btn-primary" style="margin-top:14px;">Save Team</button>
  </section>

</main>



<script>
// -------------------------------
// GLOBAL STATE
// -------------------------------
let selectedMatch = null;
let matchPlayers = [];
let chosenXI = [];


// -------------------------------
// LOAD MATCHES
// -------------------------------
(async function loadMatches() {
  const r = await fetch("/api/matches");
  const matches = await r.json();

  const ms = document.getElementById("matchSelect");
  ms.innerHTML = matches.map(m => `
    <option value="${m._id}">${m.name}</option>
  `).join("");

  if (matches.length > 0) {
    selectedMatch = matches[0]._id;
    loadPlayers();
  }

  ms.addEventListener("change", () => {
    selectedMatch = ms.value;
    loadPlayers();
  });
})();


// -------------------------------
// LOAD PLAYERS FOR MATCH
// -------------------------------
async function loadPlayers() {
  const r = await fetch(`/api/matches/${selectedMatch}/players`);
  const j = await r.json();

  if (!j.ok) {
    document.getElementById("playersList").innerHTML = "No players available.";
    return;
  }

  matchPlayers = j.players;
  renderPlayers();
}


// -------------------------------
// RENDER PLAYER LIST
// -------------------------------
function renderPlayers() {
  const box = document.getElementById("playersList");

  const query = document.getElementById("playerSearch").value.toLowerCase();

  const filtered = matchPlayers.filter(p =>
    p.playerName.toLowerCase().includes(query) ||
    p.role.toLowerCase().includes(query)
  );

  if (filtered.length === 0) {
    box.innerHTML = "<div class='muted'>No players match your search.</div>";
    return;
  }

  box.innerHTML = filtered.map((p, idx) => `
    <div class="match-row">
      <strong>${p.playerName}</strong>
      <span class="muted">${p.role} • ${p.credits} credits</span><br>
      <button class="btn-ghost" onclick="addPlayer(${idx})">Add</button>
    </div>
  `).join("");
}


// -------------------------------
// ADD PLAYER TO XI
// -------------------------------
function addPlayer(index) {
  if (chosenXI.length >= 11) {
    alert("You can only pick 11 players.");
    return;
  }

  const p = matchPlayers[index];

  if (chosenXI.find(x => x === p.playerName)) {
    alert("Player already selected.");
    return;
  }

  chosenXI.push(p.playerName);
  renderChosen();
}


// -------------------------------
// REMOVE PLAYER
// -------------------------------
function removePlayer(name) {
  chosenXI = chosenXI.filter(p => p !== name);
  renderChosen();
}


// -------------------------------
// RENDER CHOSEN XI
// -------------------------------
function renderChosen() {
  const box = document.getElementById("yourTeam");

  if (chosenXI.length === 0) {
    box.innerHTML = "<div class='muted'>No players selected.</div>";
    return;
  }

  box.innerHTML = chosenXI.map(p => `
    <div class="match-row">
      ${p}
      <button class="btn-ghost" style="margin-top:6px;" onclick="removePlayer('${p}')">Remove</button>
    </div>
  `).join("");

  // Update captain & vice list
  document.getElementById("captainSelect").innerHTML =
    chosenXI.map(x => `<option value="${x}">${x}</option>`).join("");

  document.getElementById("viceSelect").innerHTML =
    chosenXI.map(x => `<option value="${x}">${x}</option>`).join("");
}


// -------------------------------
// TEAM SUBMISSION
// -------------------------------
document.getElementById("submitTeam").addEventListener("click", async () => {
  if (chosenXI.length !== 11) {
    alert("Your team must contain exactly 11 players.");
    return;
  }

  const captain = document.getElementById("captainSelect").value;
  const vice = document.getElementById("viceSelect").value;

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Please login to create a team.");
    return;
  }

  // TEAM LOCK CHECK
  const matchInfo = await fetch(`/api/matches/${selectedMatch}`);
  const m = await matchInfo.json();
  const start = new Date(m.startTime);
  if (Date.now() > start.getTime()) {
    alert("Team creation is closed: match already started.");
    return;
  }

  const payload = {
    matchId: selectedMatch,
    players: chosenXI,
    captain,
    vice,
    viewerName: "Viewer"
  };

  const r = await fetch(`/api/matches/${selectedMatch}/teams`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  const j = await r.json();

  if (j.ok) {
    alert("Team created successfully!");
    window.location.href = "/contests.html";
  } else {
    alert("Error: " + (j.error || "unknown"));
  }
});


// SEARCH listeners
document.getElementById("playerSearch").addEventListener("input", renderPlayers);

</script>

</body>
</html>
