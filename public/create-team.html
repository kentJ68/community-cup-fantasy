<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Team</title>
  <style>
    /* Minimal dark UI styling similar to your screenshot */
    body { background:#0f1113; color:#e6eef3; font-family: Arial, sans-serif; margin:20px; }
    .card { background:#0b0c0d; border:1px solid #1f2a33; padding:18px; border-radius:10px; margin-bottom:12px; box-shadow: 0 2px 6px rgba(0,0,0,0.6); }
    label { display:block; margin-bottom:6px; color:#cfe3ee; font-weight:600; }
    select,input[type=text],button { width:100%; padding:10px; border-radius:6px; border:1px solid #23303a; background:#0c0d0e; color:#d7e9f2; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    .players-list { max-height:300px; overflow:auto; border:1px solid #1a2328; border-radius:6px; padding:8px; margin-top:8px; background:#070809; }
    .player-item { padding:8px; border-radius:6px; margin-bottom:6px; cursor:pointer; background:transparent; border:1px solid rgba(255,255,255,0.02); }
    .player-item.selected { background:#123238; border-color:#1f8b7a; }
    .chosen-list { min-height:40px; padding:8px; border-radius:6px; border:1px dashed #203135; background:#071014; margin-top:8px; }
    .hint { color:#93b2bd; font-size:13px; margin-top:6px; }
    .muted { color:#7b8b90; font-size:13px; }
    button.primary { background:#1f8b7a; color:white; border:none; cursor:pointer; }
    button.primary[disabled] { opacity:0.45; cursor:not-allowed; }
  </style>
</head>
<body>
  <h2>Create Your Fantasy Team</h2>
  <p class="muted">Pick 11 players, choose captain and vice-captain, then save your team to join contests.</p>

  <div class="card">
    <label for="matchSelect">Select Match</label>
    <select id="matchSelect">
      <option value="">Loading matches…</option>
    </select>
  </div>

  <div class="card">
    <label for="playerSearch">Search Player</label>
    <input id="playerSearch" type="text" placeholder="Search by name or role (e.g. BAT, BOW)" />
    <div class="hint">Click a player to add/remove from your XI. You need exactly 11 players to save.</div>

    <h3 style="margin-top:14px;">Available Players</h3>
    <div id="availablePlayers" class="players-list">Select a match first.</div>
  </div>

  <div class="card">
    <h3>Your XI</h3>
    <div class="row" style="align-items:flex-start;">
      <div class="col">
        <label for="captainSelect">Captain</label>
        <select id="captainSelect"><option value="">Choose Captain</option></select>
      </div>
      <div class="col">
        <label for="viceSelect">Vice-Captain</label>
        <select id="viceSelect"><option value="">Choose Vice-Captain</option></select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Selected Players (click to remove)</label>
      <div id="chosenXI" class="chosen-list">No players selected.</div>
      <div class="hint" style="margin-top:8px;">You must select exactly 11 players to enable Save Team.</div>
    </div>

    <div style="margin-top:12px;">
      <button id="submitTeam" class="primary" disabled>Save Team</button>
    </div>
  </div>

  <script>
    // ------------------------------
    // Shared page state
    // ------------------------------
    // Do NOT redeclare selectedMatch if it already exists in other scripts
    if (typeof selectedMatch === "undefined") {
      var selectedMatch = null;
    } else {
      selectedMatch = selectedMatch || null;
    }

    // chosenXI holds playerName strings
    let chosenXI = [];

    // cached players for selected match
    let matchPlayers = []; // array of { playerName, role, playerId, ... }

    // element references
    const matchSelect = document.getElementById("matchSelect");
    const availablePlayersContainer = document.getElementById("availablePlayers");
    const captainSelect = document.getElementById("captainSelect");
    const viceSelect = document.getElementById("viceSelect");
    const chosenXIContainer = document.getElementById("chosenXI");
    const playerSearch = document.getElementById("playerSearch");
    const submitBtn = document.getElementById("submitTeam");

    // ---------- Helpers ----------
    function makeOption(val, text) {
      const o = document.createElement("option");
      o.value = val;
      o.textContent = text;
      return o;
    }

    function renderChosenXI() {
      chosenXIContainer.innerHTML = "";
      if (chosenXI.length === 0) {
        chosenXIContainer.textContent = "No players selected.";
        updateSubmitState();
        return;
      }
      chosenXI.forEach(name => {
        const p = document.createElement("div");
        p.className = "player-item selected";
        p.style.marginBottom = "6px";
        p.textContent = name;
        p.addEventListener("click", () => {
          // remove on click
          const idx = chosenXI.indexOf(name);
          if (idx !== -1) chosenXI.splice(idx, 1);
          // unselect in available list if present
          const nodes = availablePlayersContainer.querySelectorAll('.player-item');
          nodes.forEach(n => {
            if (n.dataset.name === name) n.classList.remove('selected');
          });
          renderChosenXI();
          updateCaptainViceOptions();
          updateSubmitState();
        });
        chosenXIContainer.appendChild(p);
      });
      updateSubmitState();
    }

    function updateCaptainViceOptions() {
      // keep the captain/vice selects filled with chosenXI (prefer chosenXI order)
      const entries = chosenXI.length ? chosenXI.slice() : matchPlayers.map(p=>p.playerName);
      // create a unique list preserving order
      const uniq = [...new Set(entries)];
      captainSelect.innerHTML = "";
      viceSelect.innerHTML = "";
      captainSelect.appendChild(makeOption("", "Choose Captain"));
      viceSelect.appendChild(makeOption("", "Choose Vice-Captain"));
      uniq.forEach(nm => {
        captainSelect.appendChild(makeOption(nm, nm));
        viceSelect.appendChild(makeOption(nm, nm));
      });

      // if current captain/vice not in options, clear them
      if (![...captainSelect.options].some(o => o.value === captainSelect.value)) captainSelect.value = "";
      if (![...viceSelect.options].some(o => o.value === viceSelect.value)) viceSelect.value = "";
    }

    function updateSubmitState() {
      // enable submit only when a match selected and exactly 11 players chosen
      const ok = selectedMatch && chosenXI.length === 11;
      submitBtn.disabled = !ok;
      if (ok) {
        submitBtn.classList.add("primary");
      } else {
        submitBtn.classList.remove("primary");
      }
    }

    // ---------- Load matches ----------
    async function loadMatches() {
      try {
        const res = await fetch("/api/matches");
        if (!res.ok) throw new Error("Failed to fetch matches: " + res.status);
        const matches = await res.json();
        matchSelect.innerHTML = "";
        matchSelect.appendChild(makeOption("", "Select Match"));
        matches.forEach(m => {
          const label = (m.name || "Match") + (m.startTime ? " — " + new Date(m.startTime).toLocaleString() : "");
          matchSelect.appendChild(makeOption(m._id, label));
        });

        // if query contains matchId, preselect it
        const params = new URLSearchParams(window.location.search);
        const qMatch = params.get("matchId");
        if (qMatch) {
          matchSelect.value = qMatch;
          await onMatchChange();
        } else {
          availablePlayersContainer.innerHTML = "Select a match";
        }
      } catch (err) {
        console.error("loadMatches error:", err);
        matchSelect.innerHTML = "";
        matchSelect.appendChild(makeOption("", "Failed to load matches"));
        availablePlayersContainer.innerHTML = "<i>Could not load matches. Check server.</i>";
      }
    }

    // ---------- When user selects a match ----------
    async function onMatchChange() {
      const mId = matchSelect.value;
      selectedMatch = mId || null;
      chosenXI = [];
      matchPlayers = [];
      playerSearch.value = "";
      availablePlayersContainer.innerHTML = "Loading players…";
      captainSelect.innerHTML = ""; viceSelect.innerHTML = "";

      if (!selectedMatch) {
        availablePlayersContainer.innerHTML = "Select a match first.";
        updateSubmitState();
        return;
      }

      try {
        const res = await fetch(`/api/matches/${selectedMatch}/players`);
        if (!res.ok) throw new Error("Failed to fetch players: " + res.status);
        const j = await res.json();
        matchPlayers = j.players || [];
        if (!matchPlayers.length) {
          availablePlayersContainer.innerHTML = "<i>No players available for this match.</i>";
          updateSubmitState();
          return;
        }

        // render players list
        renderPlayers();

        // populate captain/vice selects (initially with all players)
        updateCaptainViceOptions();
      } catch (err) {
        console.error("onMatchChange error:", err);
        availablePlayersContainer.innerHTML = "<i>Could not load players. Check server.</i>";
      } finally {
        updateSubmitState();
      }
    }

    // ---------- Render filtered players ----------
    function renderPlayers() {
      const q = (playerSearch.value || "").trim().toLowerCase();
      availablePlayersContainer.innerHTML = "";
      const list = matchPlayers.filter(p => {
        if (!q) return true;
        return (p.playerName || "").toLowerCase().includes(q) || (p.role || "").toLowerCase().includes(q);
      });

      if (!list.length) {
        availablePlayersContainer.innerHTML = "<i>No players match search.</i>";
        return;
      }

      list.forEach(p => {
        const item = document.createElement("div");
        item.className = "player-item";
        item.dataset.name = p.playerName;
        item.textContent = `${p.playerName} (${p.role || ""})`;
        // mark selected ones
        if (chosenXI.indexOf(p.playerName) !== -1) item.classList.add("selected");
        item.addEventListener("click", () => {
          const name = p.playerName;
          const idx = chosenXI.indexOf(name);
          if (idx === -1) {
            if (chosenXI.length >= 11) {
              alert("You already have 11 players");
              return;
            }
            chosenXI.push(name);
            item.classList.add("selected");
          } else {
            chosenXI.splice(idx, 1);
            item.classList.remove("selected");
          }
          renderChosenXI();
          updateCaptainViceOptions();
        });
        availablePlayersContainer.appendChild(item);
      });
    }

    // search input listener
    playerSearch.addEventListener("input", renderPlayers);

    // match selector listener
    matchSelect.addEventListener("change", onMatchChange);

    // ---------- Create Team (submit) ----------
    submitBtn.addEventListener("click", async () => {
      try {
        if (chosenXI.length !== 11) {
          alert("Your team must contain exactly 11 players.");
          return;
        }
        const captain = captainSelect.value;
        const vice = viceSelect.value;
        if (!captain) { alert("Choose a captain."); return; }
        if (!vice) { alert("Choose a vice-captain."); return; }

        const token = localStorage.getItem("token");
        if (!token) { alert("Please login to create a team."); return; }

        // TEAM LOCK CHECK
        const matchInfo = await fetch(`/api/matches/${selectedMatch}`);
        if (!matchInfo.ok) { alert("Failed to fetch match info. Try again."); return; }
        const m = await matchInfo.json();
        const start = new Date(m.startTime);
        if (Date.now() > start.getTime()) { alert("Team creation is closed: match already started."); return; }

        // get logged in user's displayName
        const meRes = await fetch("/api/me", { headers: { Authorization: "Bearer " + token } });
        if (!meRes.ok) {
          console.error("Failed to fetch /api/me:", await meRes.text());
          alert("Could not get your profile. Please login again.");
          return;
        }
        const meJson = await meRes.json();
        const viewerName = meJson?.user?.displayName;
        if (!viewerName) { alert("Your account has no display name set. Please set it in profile."); return; }

        const payload = {
          matchId: selectedMatch,
          players: chosenXI,
          captain,
          vice,
          viewerName
        };

        submitBtn.disabled = true;
        const prevText = submitBtn.textContent;
        submitBtn.textContent = "Saving...";

        const r = await fetch(`/api/matches/${selectedMatch}/teams`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });

        const j = await r.json().catch(() => ({ error: "invalid json from server" }));

        if (r.ok && j.ok) {
          const team = j.team;
          console.log("Team created:", team);
          // save to localStorage for quick lookup later
          try {
            localStorage.setItem('myTeam_' + team.matchId, JSON.stringify({ viewerName: team.viewerName, teamId: team._id }));
          } catch (err) {
            console.warn("localStorage save failed:", err);
          }

          alert("Team created successfully!");

          // if returnTo param exists (like returnTo=contest_<id>), redirect back
          const params = new URLSearchParams(window.location.search);
          const returnTo = params.get('returnTo');
          if (returnTo && returnTo.startsWith('contest_')) {
            const contestId = returnTo.replace('contest_', '');
            window.location.href = `/contest.html?id=${encodeURIComponent(contestId)}`;
            return;
          }

          // default redirect
          window.location.href = `/contests.html`;
          return;
        } else {
          console.error("Create team error:", r.status, j);
          alert("Error: " + (j.error || "unknown"));
        }
      } catch (err) {
        console.error("submitTeam error:", err);
        alert("Network or unexpected error while creating team.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Save Team";
      }
    });

    // ---------- init ----------
    document.addEventListener("DOMContentLoaded", () => {
      loadMatches();
      renderChosenXI();
      updateSubmitState();
    });

    // Expose some things to window for debugging (optional)
    window.__debug = {
      get selectedMatch() { return selectedMatch; },
      get chosenXI() { return chosenXI; },
      get matchPlayers() { return matchPlayers; }
    };
  </script>
</body>
</html>
