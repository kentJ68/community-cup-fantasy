<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin — Roster</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="container">
    <header><h1>Admin — Roster</h1><a href="/admin/matches.html">Back</a></header>

    <main>
      <section class="card">
        <label>Select Match</label>
        <select id="matchSelect"></select>
        <input id="adminToken" placeholder="Admin token (required)" />
      </section>

      <section class="card">
        <label>Upload CSV (playerName,role,realTeam,credits)</label>
        <input type="file" id="csvFile" accept=".csv" />
        <button id="uploadBtn">Upload CSV</button>
        <div id="uploadMsg"></div>
      </section>

      <section class="card">
        <h3>Roster Preview</h3>
        <div id="preview">No match selected</div>
      </section>
    </main>
  </div>

<script>
const el = id => document.getElementById(id);

// Load matches
async function loadMatches() {
  const r = await fetch('/api/matches');
  const m = await r.json();
  el('matchSelect').innerHTML = m.map(x =>
    `<option value="${x._id}">${x.name}</option>`
  ).join('');

  if (m[0]) loadPreview(m[0]._id);
}

// Preview roster
async function loadPreview(matchId) {
  const r = await fetch(`/api/matches/${matchId}/players`);
  const j = await r.json();
  const arr = j.players || [];
  el('preview').innerHTML =
    arr.length === 0
      ? '<div>No players</div>'
      : arr.map(p =>
          `<div>${p.playerName} — ${p.role} — ${p.realTeam} (${p.credits})</div>`
        ).join('');
}

// Upload CSV
el('uploadBtn').addEventListener('click', async () => {
  const file = el('csvFile').files[0];
  if (!file) return alert("Choose a CSV file.");

  const token = el('adminToken').value.trim();
  if (!token) return alert("Enter admin token.");

  const fd = new FormData();
  fd.append("rosterCsv", file);

  const r = await fetch(`/api/admin/matches/${el('matchSelect').value}/roster-csv`, {
    method: "POST",
    headers: { "x-admin-token": token },
    body: fd
  });

  const j = await r.json();
  if (j.ok) {
    el('uploadMsg').textContent = `Imported ${j.count} players`;
    loadPreview(el('matchSelect').value);
  } else {
    el('uploadMsg').textContent = "Error: " + j.error;
  }
});

el('matchSelect').addEventListener('change', e => loadPreview(e.target.value));
loadMatches();
</script>
</body>
</html>
