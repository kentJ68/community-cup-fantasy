<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin • Manage Matches</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>

<!-- GLOBAL LAYOUT -->
<script src="/js/layout.js"></script>

<main class="main">

  <h2>Admin • Manage Matches</h2>
  <p class="muted">Create matches, delete matches, upload rosters.</p>

  <!-- CREATE MATCH -->
  <section class="card">
    <h3>Create New Match</h3>

    <div class="form-grid">
      <div>
        <label>Match Name</label>
        <input id="matchName" class="input" placeholder="India vs Pakistan T10">
      </div>

      <div>
        <label>Team A</label>
        <input id="teamA" class="input" placeholder="India">
      </div>

      <div>
        <label>Team B</label>
        <input id="teamB" class="input" placeholder="Pakistan">
      </div>

      <div>
        <label>Start Time</label>
        <input id="startTime" class="input" type="datetime-local">
      </div>

      <div>
        <label>Stream URL (optional)</label>
        <input id="streamUrl" class="input">
      </div>
    </div>

    <button class="btn-primary" style="margin-top:14px;" onclick="createMatch()">Create Match</button>
  </section>

  <!-- MATCH LIST -->
  <section class="card">
    <h3>Existing Matches</h3>
    <div id="matchList" class="muted">Loading matches…</div>
  </section>

  <!-- ROSTER UPLOAD -->
  <section class="card">
    <h3>Upload Roster (CSV or JSON)</h3>

    <label>Select Match</label>
    <select id="rosterMatchSelect" class="input"></select>

    <div style="margin-top:12px;">
      <label>CSV Upload</label>
      <input type="file" id="csvFile" accept=".csv" class="input">
      <button class="btn-primary" style="margin-top:8px;" onclick="uploadCSV()">Upload CSV</button>
    </div>

    <div style="margin-top:20px;">
      <label>JSON Upload</label>
      <textarea id="jsonRoster" class="input" rows="5" placeholder='[{ "playerName": "...", "role": "BAT", "credits": 9 }]'></textarea>
      <button class="btn-primary" style="margin-top:8px;" onclick="uploadJSON()">Upload JSON</button>
    </div>
  </section>

</main>

<script>
const ADMIN_TOKEN = "Ok12345";

// AUTO CHECK ADMIN
if (!localStorage.getItem("adminToken")) {
  localStorage.setItem("adminToken", ADMIN_TOKEN);
}

// LOAD MATCHES
async function loadMatches() {
  const r = await fetch("/api/matches");
  const matches = await r.json();

  const list = document.getElementById("matchList");
  const rosterSelect = document.getElementById("rosterMatchSelect");

  if (!matches.length) {
    list.innerHTML = "<div class='muted'>No matches created</div>";
    rosterSelect.innerHTML = "<option>No matches</option>";
    return;
  }

  rosterSelect.innerHTML = matches.map(m => `
    <option value="${m._id}">${m.name}</option>
  `).join("");

  list.innerHTML = matches.map(m => `
    <div class="match-row">
      <div>
        <strong>${m.name}</strong><br>
        <span class="muted small">${m.teamA} vs ${m.teamB}</span><br>
        <span class="muted small">${new Date(m.startTime).toLocaleString()}</span>
      </div>

      <button class="btn-danger" onclick="deleteMatch('${m._id}')">Delete</button>
    </div>
  `).join("");
}

loadMatches();


// CREATE MATCH
async function createMatch() {
  const name = document.getElementById("matchName").value.trim();
  const teamA = document.getElementById("teamA").value.trim();
  const teamB = document.getElementById("teamB").value.trim();
  const startTime = document.getElementById("startTime").value;
  const streamUrl = document.getElementById("streamUrl").value;

  if (!name || !teamA || !teamB || !startTime) {
    alert("Please fill all required fields.");
    return;
  }

  const r = await fetch("/api/admin/matches", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Token": ADMIN_TOKEN
    },
    body: JSON.stringify({ name, teamA, teamB, startTime, streamUrl })
  });

  const j = await r.json();

  if (j.ok) {
    alert("Match created!");
    loadMatches();
  } else {
    alert("Error: " + j.error);
  }
}


// DELETE MATCH
async function deleteMatch(id) {
  if (!confirm("Delete this match? This removes all connected contests & teams.")) return;

  const r = await fetch(`/api/admin/matches/${id}`, {
    method: "DELETE",
    headers: {
      "X-Admin-Token": ADMIN_TOKEN
    }
  });

  const j = await r.json();

  if (j.ok) {
    alert("Match deleted.");
    loadMatches();
  } else {
    alert("Error: " + j.error);
  }
}


// UPLOAD CSV
async function uploadCSV() {
  const matchId = document.getElementById("rosterMatchSelect").value;
  const file = document.getElementById("csvFile").files[0];

  if (!file) {
    alert("Select a CSV file first.");
    return;
  }

  const form = new FormData();
  form.append("rosterCsv", file);

  const r = await fetch(`/api/admin/matches/${matchId}/roster-csv`, {
    method: "POST",
    headers: { "X-Admin-Token": ADMIN_TOKEN },
    body: form
  });

  const j = await r.json();
  alert(j.ok ? "CSV uploaded successfully!" : "Error: " + j.error);
}


// UPLOAD JSON
async function uploadJSON() {
  const matchId = document.getElementById("rosterMatchSelect").value;
  let text = document.getElementById("jsonRoster").value;

  try {
    text = JSON.parse(text);
  } catch {
    alert("Invalid JSON format.");
    return;
  }

  const r = await fetch(`/api/admin/matches/${matchId}/roster`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Token": ADMIN_TOKEN
    },
    body: JSON.stringify({ players: text })
  });

  const j = await r.json();
  alert(j.ok ? "Roster updated!" : "Error: " + j.error);
}
</script>

</body>
</html>