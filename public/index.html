<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beowulf Community Cup Fantasy</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="app">
    <script src="/js/layout.js"></script>

    <main class="main">
      <section class="card hero">
        <div class="hero-left">
          <h1 style="margin-bottom:6px;">Welcome to the Community Cup Fantasy</h1>
          <p class="muted" style="max-width:720px;">
            Join contests, build your dream XI, track leaderboards, and compete for season-long glory.
            Real-time scoring powered by viewer participation.
          </p>

          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <a class="btn-primary" href="/create-team.html">Create Team</a>
            <a class="btn-ghost" href="/contests.html">Browse Contests</a>
            <span id="healthPill" class="status-pill" style="margin-left:8px">Checking server…</span>
          </div>
        </div>

        <div class="hero-right" style="align-self:flex-start;">
          <!-- small dashboard summary -->
          <div class="card small" style="width:220px;">
            <div style="font-weight:700;font-size:1rem;">Season</div>
            <div class="muted small" style="margin-top:6px;">Accumulated points across matches</div>
            <div style="margin-top:12px;">
              <div class="season-stat">—</div>
              <div class="season-label">Top Rank: <span id="topRank">—</span></div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h3>Upcoming Matches</h3>
        <div id="upcomingMatches" class="muted">Loading matches…</div>
      </section>

    </main>
  </div>

<script>
  // small helper: prefer App.get if available
  async function apiGet(path){
    if (window.App && typeof window.App.get === 'function'){
      try {
        const r = await App.get(path);
        if (r && r.ok) return r.data || r;
        // if App.get returns safeJson wrapper, r.data holds actual data
        if (r && r.data) return r.data;
        return r;
      } catch(e){
        // fallback to fetch
      }
    }

    const res = await fetch(path);
    if (!res.ok) throw new Error('Network error: ' + res.status);
    return res.json();
  }

  // Format date nicely
  function fmtDate(d){
    if (!d) return '';
    try { return new Date(d).toLocaleString(); } catch(e){ return d; }
  }

  // Load server health
  async function loadHealth(){
    const pill = document.getElementById('healthPill');
    try {
      const j = await apiGet('/api/health');
      if (j && (j.ok || j.time)){
        pill.textContent = 'Server Online';
        pill.classList.add('ok');
      } else {
        pill.textContent = 'Server Issue';
      }
    } catch (e){
      pill.textContent = 'Offline';
    }
  }

  // Render upcoming matches
  async function loadMatches(){
    const box = document.getElementById('upcomingMatches');
    box.innerHTML = '<div class="muted">Loading matches…</div>';
    try {
      const matches = await apiGet('/api/matches');
      if (!matches || matches.length === 0){
        box.innerHTML = '<div class="muted">No matches scheduled</div>';
        return;
      }

      // Sort by startTime ascending
      matches.sort((a,b)=>{
        const ta = a.startTime ? new Date(a.startTime).getTime() : 0;
        const tb = b.startTime ? new Date(b.startTime).getTime() : 0;
        return ta - tb;
      });

      box.innerHTML = matches.map(m => {
        // Use m.name if present; otherwise create from teamA vs teamB
        const title = m.name && m.name.trim() ? m.name : `${m.teamA || ''} vs ${m.teamB || ''}`;
        const teams = (m.teamA || m.teamB) ? `${m.teamA || ''} vs ${m.teamB || ''}` : '';
        const time = m.startTime ? fmtDate(m.startTime) : '';
        return `
          <div class="match-list-item">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div style="flex:1;">
                <strong>${escapeHtml(title)}</strong>
                <div class="muted small">${escapeHtml(teams)}</div>
              </div>
              <div style="white-space:nowrap;text-align:right;">
                <div class="muted small">${escapeHtml(time)}</div>
                <div style="margin-top:6px;">
                  <a class="btn-ghost small" href="/contests.html?match=${encodeURIComponent(m._id || '')}">Contests</a>
                  <a class="btn-ghost small" href="/leaderboard.html?match=${encodeURIComponent(m._id || '')}" style="margin-left:8px;">Leaderboard</a>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

    } catch (err){
      console.error(err);
      box.innerHTML = '<div class="muted">Failed to load matches</div>';
    }
  }

  // basic escape to avoid accidental HTML injection
  function escapeHtml(s){
    if (!s && s !== 0) return '';
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // init
  (function(){
    loadHealth();
    loadMatches();

    // if App available, initialize it
    try { if (window.App && typeof App.init === 'function') App.init(); } catch(e){}

    // auto refresh matches when coming back from other pages
    window.addEventListener('focus', () => { loadHealth(); loadMatches(); });
  })();
</script>
</body>
</html>
