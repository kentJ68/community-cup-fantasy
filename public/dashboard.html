<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • Beowulf Fantasy League</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>

<!-- Layout System -->
<script src="/js/layout.js"></script>

<main class="main">

  <h2>Your Dashboard</h2>
  <p class="muted">Welcome back! Track your fantasy career, recent matches & season progress.</p>

  <!-- USER SUMMARY -->
  <section class="card">
    <h3>Your Fantasy Summary</h3>

    <div id="userSummary" class="muted">Loading…</div>
  </section>

  <!-- RECENT MATCHES JOINED -->
  <section class="card">
    <h3>Your Recent Matches</h3>
    <div id="recentMatches" class="muted">Loading…</div>
  </section>

  <!-- SEASON RANK -->
  <section class="card">
    <h3>Your Season Rank</h3>
    <div id="seasonRank" class="muted">Loading…</div>
  </section>

</main>


<script>
// Load User Summary (name + avatar + total teams)
(async function() {
  const token = localStorage.getItem("token");
  const box = document.getElementById("userSummary");

  if (!token) {
    box.innerHTML = "Please <a href='/login.html'>login</a> to view dashboard.";
    return;
  }

  const r = await fetch("/api/me", { headers:{ Authorization: "Bearer " + token }});
  const j = await r.json();

  if (!j.ok) {
    box.innerHTML = "Unable to load profile.";
    return;
  }

  const u = j.user;
  box.innerHTML = `
    <div style="display:flex;align-items:center;gap:14px;">
      <img src="${u.avatarUrl || '/assets/default-avatar.png'}" style="width:60px;height:60px;border-radius:8px;">
      <div>
        <strong>${u.displayName || "Viewer"}</strong><br>
        <span class="muted">${u.email || ""}</span>
      </div>
    </div>
  `;
})();


// Recent Matches (teams user created or joined)
(async function() {
  const box = document.getElementById("recentMatches");
  try {
    const r = await fetch("/api/matches");
    const matches = await r.json();

    if (!matches || matches.length === 0) {
      box.innerHTML = "<div class='muted'>No matches yet.</div>";
      return;
    }

    box.innerHTML = matches.slice(0, 5).map(m => `
      <div class="match-row">
        <strong>${m.name}</strong>
        <div class="muted small">${m.teamA} vs ${m.teamB}</div>
        <div class="muted small">${new Date(m.startTime).toLocaleString()}</div>
        <a href="/leaderboard.html?match=${m._id}" class="btn-ghost" style="margin-top:6px;">View Leaderboard</a>
      </div>
    `).join("");

  } catch {
    box.innerHTML = "Error loading matches.";
  }
})();


// Season Rank
(async function(){
  const box = document.getElementById("seasonRank");

  try {
    const r = await fetch("/api/season/leaderboard");
    const j = await r.json();

    if (!j.ok || j.leaderboard.length === 0) {
      box.innerHTML = "<div class='muted'>No season data yet.</div>";
      return;
    }

    const token = localStorage.getItem("token");
    let viewerName = "";
    if (token) {
      const me = await fetch("/api/me", { headers:{ Authorization:"Bearer " + token }});
      const d = await me.json();
      viewerName = d?.user?.displayName || "";
    }

    if (!viewerName) {
      box.innerHTML = "<div class='muted'>Login to view your rank.</div>";
      return;
    }

    let rank = j.leaderboard.findIndex(v => v.viewerName === viewerName);
    if (rank === -1) {
      box.innerHTML = "<div class='muted'>No entries yet.</div>";
      return;
    }

    rank = rank + 1;
    const total = j.leaderboard[rank - 1].total;

    box.innerHTML = `
      <div class="stat-card">
        <div class="stat-big">#${rank}</div>
        <div class="muted">Your position in the season standings</div>
        <div style="margin-top:8px;">Total Points: <strong>${total}</strong></div>
      </div>
    `;
  } catch (err) {
    box.innerHTML = "Failed loading season rank.";
  }
})();
</script>

</body>
</html>