<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin • Roster Generator</title>

<link rel="stylesheet" href="/css/style.css" />
<style>
  .card { padding:16px; margin-bottom:16px; }
  .player-box { padding:8px; border:1px solid #333; border-radius:6px; }
</style>
</head>

<body>
<div class="app">
  <main class="main">

    <h2>Admin • Roster Generator</h2>
    <p class="muted">Upload, preview & push player rosters for matches.</p>

    <!-- IMPORT CSV -->
    <section class="card">
      <h3>Import CSV</h3>
      <input type="file" id="csvFile" accept=".csv,.xlsx" />
      <button id="loadCsvBtn" class="btn-primary" style="margin-top:8px;">Load CSV</button>

      <p class="muted small">CSV Format: <strong>playerName, role, realTeam, credits, status</strong></p>
      <div id="csvStatus" class="muted small"></div>
    </section>

    <!-- Roster Preview -->
    <section class="card">
      <h3>Roster Preview</h3>
      <div id="rosterList" class="muted">No players loaded.</div>
    </section>

    <!-- PUSH TO MATCH -->
    <section class="card">
      <h3>Push Roster to Match</h3>

      <label>Admin Token</label>
      <input id="adminToken" placeholder="Admin token" value="Ok12345" />

      <br><br>

      <label>Select Match</label>
      <select id="matchSelect"></select>

      <br><br>

      <button id="pushRosterBtn" class="btn-primary">Push Roster</button>
      <div id="pushStatus" class="muted small"></div>
    </section>

  </main>
</div>

<script>
// -------------------------------
// Load matches into dropdown
// -------------------------------
async function loadMatches() {
  try {
    const r = await fetch("/api/matches");
    const matches = await r.json();

    const sel = document.getElementById("matchSelect");
    sel.innerHTML = matches.map(m => 
      `<option value="${m._id}">${m.name}</option>`
    ).join("");
  } catch (e) {
    console.error("Failed loading matches:", e);
  }
}
loadMatches();

// -------------------------------
// CSV PARSER (Safe)
// -------------------------------
function parseCSV(text) {
  text = text.replace(/^\uFEFF/, "").replace(/\r\n/g, "\n").trim();
  if (!text) return { header: [], rows: [] };

  const lines = text.split("\n");
  const header = lines[0].split(",").map(h => h.trim().toLowerCase());
  const rows = lines.slice(1).map(line =>
    line.split(",").map(x => x.trim())
  );
  return { header, rows };
}

// -------------------------------
// MAP CSV → Player object
// -------------------------------
function normalizePlayer(row, header) {
  const obj = {};
  header.forEach((h, i) => obj[h] = row[i] || "");

  return {
    playerId: obj.playerid || "",
    playerName: obj.playername || obj.player_name || "",
    role: (obj.role || "BAT").toUpperCase(),
    realTeam: obj.realteam || "",
    credits: Number(obj.credits || 0),
    status: obj.status || "active"
  };
}

// -------------------------------
// Load CSV + Create Preview
// -------------------------------
let rosterPlayers = [];

document.getElementById("loadCsvBtn").onclick = async function () {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Select a CSV file first");

  document.getElementById("csvStatus").innerText = "Reading file...";

  const text = await file.text();
  const parsed = parseCSV(text);

  rosterPlayers = parsed.rows
    .map(row => normalizePlayer(row, parsed.header))
    .filter(p => p.playerName);

  renderRosterPreview();
  document.getElementById("csvStatus").innerText =
    `Loaded ${rosterPlayers.length} players`;
};

// -------------------------------
// Render Roster Preview
// -------------------------------
function renderRosterPreview() {
  const box = document.getElementById("rosterList");
  if (!rosterPlayers.length) {
    box.innerHTML = "<div class='muted'>No players loaded.</div>";
    return;
  }

  box.innerHTML = rosterPlayers
    .map(
      p => `
      <div class="player-box">
        <strong>${p.playerName}</strong><br>
        <span class="muted small">${p.role} • ${p.realTeam} • ${p.credits} credits</span>
      </div>`
    )
    .join("");
}

// -------------------------------
// PUSH ROSTER TO SERVER
// -------------------------------
document.getElementById("pushRosterBtn").onclick = async function () {
  if (!rosterPlayers.length) return alert("No roster loaded");

  const matchId = document.getElementById("matchSelect").value;
  const adminToken = document.getElementById("adminToken").value;

  const url = `/api/admin/matches/${matchId}/roster?adminToken=${adminToken}`;
  const pushStatus = document.getElementById("pushStatus");

  pushStatus.innerText = "Pushing roster...";

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-admin-token": adminToken },
      body: JSON.stringify({ players: rosterPlayers })
    });

    const j = await res.json();

    if (j.ok) {
      pushStatus.innerText = `Roster pushed successfully ✓`;
      alert("Roster saved!");
    } else {
      pushStatus.innerText = "Error: " + j.error;
    }
  } catch (err) {
    pushStatus.innerText = "Push failed: " + err.message;
  }
};
</script>

</body>
</html>
