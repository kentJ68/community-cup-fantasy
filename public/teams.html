<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teams • Beowulf Fantasy</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .teams-list { display:flex; flex-direction:column; gap:10px; }
    .team-row { display:flex; gap:12px; align-items:center; padding:10px; border-radius:8px; background:var(--card); }
    .team-info { flex:1; }
    .team-meta { color:var(--muted); font-size:0.9rem; }
    .btn-small { padding:6px 8px; font-size:13px; border-radius:6px; cursor:pointer; }
    .btn-danger { background:#c43; color:#fff; border:none; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:6px 8px; border-radius:6px; cursor:pointer; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:2000; }
    .modal .card { width:720px; max-width:95%; max-height:85vh; overflow:auto; padding:16px; border-radius:10px; }
    .player-list { margin-top:8px; display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
    .player-item { padding:6px; background:rgba(255,255,255,0.02); border-radius:6px; display:flex; justify-content:space-between; }
    .muted { color:var(--muted); }
    .small { font-size:0.85rem; }
    .logo-thumb { width:48px;height:48px;border-radius:8px;object-fit:cover;margin-right:8px }
  </style>
</head>
<body>
  <div class="app">
    <script src="/js/layout.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <main class="main">
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <h2>Teams</h2>
          <div>
            <button id="btnAdminAuth" class="btn-ghost small">Admin: set token</button>
            <button id="refreshBtn" class="btn-ghost small">Refresh</button>
          </div>
        </div>

        <p class="muted small">Viewing teams for match <span id="matchIdLabel">—</span>. If you are an admin you can delete any team; otherwise team owners can delete their own teams.</p>

        <div id="teamsContainer" class="teams-list" style="margin-top:12px;">
          <div class="muted">Loading teams…</div>
        </div>
      </section>
    </main>
  </div>

  <!-- View Team Modal -->
  <div id="viewModal" class="modal" role="dialog" aria-hidden="true">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <h3 id="modalTeamName">Team</h3>
          <div class="muted small" id="modalTeamMeta">by <span id="modalViewerName">—</span> • <span id="modalCreatedAt">—</span></div>
        </div>
        <div>
          <button id="modalDeleteBtn" class="btn-danger btn-small" style="display:none">Delete Team</button>
          <button id="modalCloseBtn" class="btn-ghost btn-small" style="margin-left:8px">Close</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="font-weight:700">Players</div>
          <div class="muted small" id="modalCaptVice" style="margin-left:8px"></div>
        </div>
        <div id="modalPlayerList" class="player-list"></div>

        <div style="margin-top:12px;">
          <div class="muted small">Team ID: <span id="modalTeamId">—</span></div>
          <div class="muted small">Linked channel: <span id="modalLinkedChannel">—</span></div>
        </div>
      </div>
    </div>
  </div>

<script>
(async function(){
  function qs(q){ return document.querySelector(q); }
  function qsa(q){ return Array.from(document.querySelectorAll(q)); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  const urlParams = new URLSearchParams(location.search);
  const MATCH_ID = urlParams.get('match') || '';
  document.getElementById('matchIdLabel').textContent = MATCH_ID || 'none';

  let TEAMS = [];
  let ADMIN_TOKEN = null;
  let JWT = localStorage.getItem('token') || null;

  // socket
  let socket = null;
  try {
    socket = io();
    socket.on('connect', ()=>{ if (MATCH_ID) socket.emit('joinMatch', MATCH_ID); });
    socket.on('teamDeleted', (d) => { if (d && String(d.matchId) === String(MATCH_ID)) loadTeams(); });
    socket.on('teamCreated', (d) => { if (d && String(d.matchId) === String(MATCH_ID)) loadTeams(); });
  } catch (e){ console.warn('socket not available', e); }

  qs('#refreshBtn').addEventListener('click', loadTeams);
  qs('#btnAdminAuth').addEventListener('click', async ()=>{
    const t = prompt('Paste ADMIN token (x-admin-token) or leave empty to clear:');
    ADMIN_TOKEN = t ? t.trim() : null;
    alert(ADMIN_TOKEN ? 'Admin token set (will be used for deletes).' : 'Admin token cleared.');
  });

  const viewModal = qs('#viewModal');
  const modalTeamName = qs('#modalTeamName');
  const modalViewerName = qs('#modalViewerName');
  const modalCreatedAt = qs('#modalCreatedAt');
  const modalPlayerList = qs('#modalPlayerList');
  const modalTeamId = qs('#modalTeamId');
  const modalLinkedChannel = qs('#modalLinkedChannel');
  const modalCaptVice = qs('#modalCaptVice');
  const modalDeleteBtn = qs('#modalDeleteBtn');
  const modalCloseBtn = qs('#modalCloseBtn');

  modalCloseBtn.addEventListener('click', ()=>{ closeModal(); });
  viewModal.addEventListener('click', (e)=> { if (e.target === viewModal) closeModal(); });

  function openModal(team, canDelete) {
    modalTeamName.textContent = team.name || 'Team';
    modalViewerName.textContent = team.viewerName || '—';
    modalCreatedAt.textContent = team.createdAt ? new Date(team.createdAt).toLocaleString() : '—';
    modalTeamId.textContent = team._id || '—';
    modalLinkedChannel.textContent = team.linkedChannel || '—';
    modalCaptVice.textContent = `Captain: ${team.captain || '—'}  Vice: ${team.vice || '—'}`;

    modalPlayerList.innerHTML = '';
    (team.players || []).forEach((p, i) => {
      const el = document.createElement('div');
      el.className = 'player-item';
      el.innerHTML = `<div>${escapeHtml(p)}</div><div class="muted small">#${i+1}</div>`;
      modalPlayerList.appendChild(el);
    });

    if (canDelete) {
      modalDeleteBtn.style.display = 'inline-block';
      modalDeleteBtn.onclick = async () => {
        if (!confirm('Delete this team? This cannot be undone.')) return;
        try {
          await deleteTeam(team.matchId || MATCH_ID, team._id);
          closeModal();
          loadTeams();
          alert('Deleted');
        } catch (err) {
          alert('Delete failed: ' + (err.message || err));
        }
      };
    } else {
      modalDeleteBtn.style.display = 'none';
      modalDeleteBtn.onclick = null;
    }

    viewModal.style.display = 'flex';
  }

  function closeModal() { viewModal.style.display = 'none'; }

  async function apiGet(path) {
    const res = await fetch(path);
    if (!res.ok) throw new Error('Network error: ' + res.status);
    return res.json();
  }

  async function deleteTeam(matchId, teamId) {
    if (!matchId || !teamId) throw new Error('Missing ids');
    async function doDelete(headers) {
      const res = await fetch(`/api/matches/${matchId}/teams/${teamId}`, { method:'DELETE', headers });
      let body = null;
      try { body = await res.json(); } catch (e) { body = { ok:false, error: 'Invalid JSON' }; }
      return { status: res.status, body };
    }

    const jwt = localStorage.getItem('token');
    if (jwt) {
      try {
        const r = await doDelete({ 'Authorization': 'Bearer ' + jwt });
        if (r.status >=200 && r.status < 300 && r.body && r.body.ok) return r.body;
        if (r.status === 403) throw new Error((r.body && (r.body.error || r.body.message)) || 'Forbidden');
      } catch (err) {
        console.warn('Delete with JWT error', err);
      }
    }

    let adminToken = window.__ADMIN_TOKEN__ || ADMIN_TOKEN || null;
    if (!adminToken) {
      adminToken = prompt('Enter ADMIN token (x-admin-token) to delete team (Cancel to abort):');
      if (!adminToken) throw new Error('Admin token required to delete');
      window.__ADMIN_TOKEN__ = adminToken;
    }

    const r2 = await doDelete({ 'x-admin-token': adminToken });
    if (r2.status >=200 && r2.status < 300 && r2.body && r2.body.ok) return r2.body;
    if (r2.status === 401) {
      window.__ADMIN_TOKEN__ = null;
      throw new Error('Admin token rejected (401). Please check the token and try again.');
    }
    throw new Error((r2.body && (r2.body.error || r2.body.message)) || `HTTP ${r2.status}`);
  }

  function tryGetUserIdFromJwt() {
    try {
      const t = localStorage.getItem('token');
      if (!t) return null;
      const parts = t.split('.');
      if (parts.length < 2) return null;
      const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
      return payload && (payload.id || payload.userId || payload.sub) || null;
    } catch (e) { return null; }
  }
  function tryGetRoleFromJwt() {
    try {
      const t = localStorage.getItem('token');
      if (!t) return null;
      const parts = t.split('.');
      if (parts.length < 2) return null;
      const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
      return payload && payload.role || null;
    } catch (e) { return null; }
  }

  async function loadTeams(){
    const container = qs('#teamsContainer');
    if (!MATCH_ID) { container.innerHTML = '<div class="muted">No match selected. Provide ?match=&lt;id&gt; in URL.</div>'; return; }
    container.innerHTML = '<div class="muted">Loading teams…</div>';
    try {
      const j = await apiGet(`/api/matches/${MATCH_ID}/teams`);
      if (!j || !j.ok) { container.innerHTML = `<div class="muted">Failed to load teams: ${escapeHtml((j && j.error) || 'unknown')}</div>`; return; }
      TEAMS = j.teams || [];
      if (!TEAMS.length) { container.innerHTML = '<div class="muted">No teams yet.</div>'; return; }

      container.innerHTML = '';
      TEAMS.forEach(team => {
        const row = document.createElement('div');
        row.className = 'team-row';

        const logo = document.createElement('img');
        logo.className = 'logo-thumb';
        logo.src = team.logoUrl || '/assets/logo.png';
        logo.onerror = function(){ this.src = '/assets/logo.png'; };

        const info = document.createElement('div');
        info.className = 'team-info';
        info.innerHTML = `<div style="display:flex;align-items:center;">
                            <div style="display:flex;flex-direction:column;">
                              <div style="font-weight:700">${escapeHtml(team.name || team.viewerName || 'Team')}</div>
                              <div class="team-meta muted small">${escapeHtml(team.viewerName || '')} • ${escapeHtml(new Date(team.createdAt||0).toLocaleString())}</div>
                            </div>
                          </div>`;

        const actions = document.createElement('div');

        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn-ghost btn-small';
        viewBtn.textContent = 'View';
        viewBtn.addEventListener('click', ()=> {
          const tokenUserId = tryGetUserIdFromJwt();
          const isOwner = tokenUserId && team.viewerId && String(tokenUserId) === String(team.viewerId);
          const hasAdminToken = !!ADMIN_TOKEN || !!JWT && tryGetRoleFromJwt() === 'admin';
          openModal(team, isOwner || hasAdminToken);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-danger btn-small';
        deleteBtn.textContent = 'Delete';

        const tokenUserId = tryGetUserIdFromJwt();
        const isOwner = tokenUserId && team.viewerId && String(tokenUserId) === String(team.viewerId);
        const hasAdminToken = !!ADMIN_TOKEN || !!JWT && tryGetRoleFromJwt() === 'admin';
        if (!(isOwner || hasAdminToken)) {
          deleteBtn.style.display = 'none';
        }
        deleteBtn.addEventListener('click', async ()=>{
          if (!confirm('Delete this team?')) return;
          try {
            await deleteTeam(team.matchId || MATCH_ID, team._id);
            loadTeams();
            alert('Deleted');
          } catch (err) {
            alert('Delete failed: ' + (err.message || err));
            console.error('Delete failed', err);
          }
        });

        row.appendChild(logo);
        row.appendChild(info);
        actions.appendChild(viewBtn);
        actions.appendChild(deleteBtn);
        row.appendChild(actions);
        container.appendChild(row);
      });

    } catch (err) {
      console.error('loadTeams err', err);
      container.innerHTML = `<div class="muted">Failed to load teams: ${escapeHtml(err.message || String(err))}</div>`;
    }
  }

  await loadTeams();

  window._teams_reload = loadTeams;
  window._teams_state = () => ({ MATCH_ID, TEAMS, ADMIN_TOKEN, JWT });

})();
</script>
</body>
</html>
