<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teams</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#06060a;color:#eef}
    .card{background:#0f0f14;padding:14px;border-radius:10px;max-width:1100px;margin:12px auto}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .team{background:#09090d;padding:12px;border-radius:10px;display:flex;gap:12px;align-items:center}
    .logo{width:64px;height:64px;border-radius:10px;object-fit:cover}
    .muted{color:#9aa;font-size:13px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} .logo{width:56px;height:56px} }
  </style>
</head>
<body>
  <div class="card">
    <h2>Match Teams</h2>
    <div style="margin-bottom:12px;">
      <label>Match ID: <input id="matchId"></label>
      <button id="loadBtn">Load Teams</button>
    </div>
    <div id="grid" class="grid"></div>
  </div>

<script>
function getToken(){ return localStorage.getItem('token'); }
async function fetchWithAuth(url, opts={}) { const t = getToken(); opts.headers = opts.headers||{}; if (t) opts.headers['Authorization']='Bearer '+t; return fetch(url, opts); }

document.getElementById('loadBtn').addEventListener('click', ()=> {
  const m = document.getElementById('matchId').value.trim();
  if (!m) return alert('Enter matchId');
  loadTeams(m);
});

async function loadTeams(matchId){
  const grid = document.getElementById('grid'); grid.innerHTML = 'Loading...';
  try {
    const r = await fetch(`/api/matches/${matchId}/teams`);
    const j = await r.json();
    if (!j.ok) { grid.innerHTML='Failed to load teams'; return; }
    const teams = j.teams || [];
    let myTeamId = null;
    const token = getToken();
    if (token) {
      try {
        const me = await fetchWithAuth(`/api/matches/${matchId}/teams/me`);
        const mj = await me.json();
        if (mj.ok && mj.team) myTeamId = mj.team._id;
      } catch {}
    }
    grid.innerHTML = teams.map(t => {
      const isMine = t._id === myTeamId;
      return `<div class="team" data-id="${t._id}" style="${isMine ? 'box-shadow:0 0 0 3px rgba(107,153,255,0.12);border:1px solid rgba(107,153,255,0.16)':''}">
        <img class="logo" src="${encodeURI(t.logoUrl || '/assets/logo.png')}" onerror="this.src='/assets/logo.png'"/>
        <div style="flex:1">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-weight:700">${escapeHtml(t.name || t.viewerName)}</div>
            ${isMine?'<div style="margin-left:auto;color:#9f6;font-weight:700">Your Team</div>':''}
          </div>
          <div class="muted">${escapeHtml(t.viewerName || '')} â€¢ ${t.totalPoints||0} pts</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            ${isMine?`<button class="deleteBtn" data-id="${t._id}">Delete</button> <label class="small">Upload logo <input type="file" class="logoFile" data-team="${t._id}" style="display:none"></label>`: ''}
          </div>
        </div>
      </div>`;
    }).join('');
    // wire delete & logo upload for own teams
    document.querySelectorAll('.deleteBtn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        if (!confirm('Delete your team?')) return;
        const teamId = b.getAttribute('data-id');
        const r = await fetchWithAuth(`/api/matches/${matchId}/teams/${teamId}`, { method: 'DELETE' });
        const j = await r.json();
        if (j.ok) { alert('Deleted'); loadTeams(matchId); } else alert('Delete failed: ' + (j.error||JSON.stringify(j)));
      });
    });
    document.querySelectorAll('.team .small input[type=file]').forEach(inp=>{
      inp.addEventListener('change', async (ev)=>{
        const file = ev.target.files[0]; if (!file) return;
        const teamId = ev.target.getAttribute('data-team');
        const form = new FormData(); form.append('logo', file);
        const r = await fetchWithAuth(`/api/matches/${matchId}/teams/${teamId}/logo`, { method: 'POST', body: form });
        const j = await r.json();
        if (j.ok) { alert('Logo updated'); loadTeams(matchId); } else alert('Logo upload failed: ' + (j.error||JSON.stringify(j)));
      });
    });
  } catch(e){ console.error(e); grid.innerHTML='Failed to load teams'; }
}

function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
